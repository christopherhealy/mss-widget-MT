<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MSS Widget Config</title>

  <!-- Global MSS UI styles -->
  <link rel="stylesheet" href="themes/MSSStylesheet.css" />
</head>
<body class="mss-root">
  <!-- Top bar -->
  <header class="mss-top">
    <div class="mss-top-inner mss-row">
      <div class="mss-stack-tight">
        <div class="mss-title">MSS Configuration Setup</div>
        <div class="mss-subtext">
          Edit <code>config.json</code> values in real time.
        </div>
      </div>
      <div class="mss-subtext">
        <span id="envTag" class="mss-pill-soft">–</span>
      </div>
    </div>
  </header>

  <main class="mss-shell">
    <div class="mss-layout">
      <!-- LEFT: MAIN CONFIG FORM -->
      <section class="mss-card">
        <header class="mss-card-header">
          <h2 class="mss-card-title">Core settings</h2>
          <p class="mss-card-subtitle">
            Theme, behaviour, API &amp; logging.
          </p>
        </header>

        <!-- Admin key (optional) -->
        <div class="mss-field">
          <label class="mss-label" for="adminKey">Admin write key (optional)</label>
          <input
            id="adminKey"
            type="password"
            class="mss-input"
            placeholder="Only if ADMIN_WRITE_KEY is set on Render"
          />
          <div class="mss-muted">
            If left blank, writes are allowed when no ADMIN_WRITE_KEY is configured on the server.
          </div>
        </div>

        <!-- Theme + upload / audio bounds -->
        <div class="mss-field-row">
          <div class="mss-field mss-field-half">
            <label class="mss-label" for="theme">Theme</label>
            <select id="theme" class="mss-input">
              <option value="apple">Apple</option>
              <option value="pink">Pink</option>
              <option value="default">Default</option>
            </select>
            <div class="mss-muted">
              Controls which CSS theme the widget loads.
            </div>
          </div>

          <div class="mss-field mss-field-half">
            <label class="mss-label">Upload behaviour</label>
            <label class="mss-pill-checkbox">
              <input id="permitUpload" type="checkbox" />
              <span>Allow “Choose an audio file” (Permitupload)</span>
            </label>
            <div class="mss-muted">
              When off, widget runs in record-only mode (no upload / clear file controls).
            </div>
          </div>
        </div>

        <div class="mss-field-row">
          <div class="mss-field mss-field-half">
            <label class="mss-label" for="audioMin">Minimum audio seconds</label>
            <input id="audioMin" type="number" min="0" class="mss-input" />
            <div class="mss-muted">
              Widget enforces this on submit (e.g. 20).
            </div>
          </div>
          <div class="mss-field mss-field-half">
            <label class="mss-label" for="audioMax">Maximum audio seconds</label>
            <input id="audioMax" type="number" min="0" class="mss-input" />
            <div class="mss-muted">
              Upper bound for answer length (e.g. 100).
            </div>
          </div>
        </div>

        <hr class="mss-divider" />

        <!-- API block -->
        <header class="mss-card-header mss-card-header-tight">
          <h2 class="mss-card-title">VoX API</h2>
          <p class="mss-card-subtitle">
            Direct VoX endpoint on
            <code>https://app.myspeakingscore.com/api/vox</code>.
          </p>
        </header>

        <div class="mss-field">
          <label class="mss-pill-checkbox">
            <input id="apiEnabled" type="checkbox" />
            <span>Enable API calls</span>
          </label>
          <div class="mss-muted">
            If disabled, widget will not submit recordings to MSS.
          </div>
        </div>

        <div class="mss-field">
          <label class="mss-label" for="apiBase">API baseUrl</label>
          <input
            id="apiBase"
            type="text"
            class="mss-input"
            placeholder="https://app.myspeakingscore.com"
          />
          <div class="mss-muted">
            Should normally be
            <code>https://app.myspeakingscore.com</code>.
          </div>
        </div>

        <div class="mss-field">
          <label class="mss-label" for="apiKey">API-KEY</label>
          <input id="apiKey" type="text" autocomplete="off" class="mss-input" />
        </div>

        <div class="mss-field">
          <label class="mss-label" for="apiSecret">X-API-SECRET</label>
          <input
            id="apiSecret"
            type="password"
            autocomplete="off"
            class="mss-input"
          />
        </div>

        <hr class="mss-divider" />

        <!-- Logger block -->
        <header class="mss-card-header mss-card-header-tight">
          <h2 class="mss-card-title">Logging</h2>
          <p class="mss-card-subtitle">
            Optional CSV logging endpoint hosted on Render.
          </p>
        </header>

        <div class="mss-field">
          <label class="mss-pill-checkbox">
            <input id="logEnabled" type="checkbox" />
            <span>Enable logging</span>
          </label>
          <div class="mss-muted">
            When enabled, widget POSTs summary data to the logger URL after a
            successful submission.
          </div>
        </div>

        <div class="mss-field">
          <label class="mss-label" for="logUrl">Logger URL</label>
          <input
            id="logUrl"
            type="text"
            class="mss-input"
            placeholder="https://msswidget-dev.onrender.com/log/submission"
          />
          <div class="mss-muted">
            Default in dev:
            <code>/log/submission</code> on your Render service.
          </div>
        </div>

        <div class="mss-actions-bottom mss-row">
          <button
            id="reloadBtn"
            type="button"
            class="mss-btn mss-btn-ghost"
          >
            Reload from server
          </button>
          <button
            id="saveBtn"
            type="button"
            class="mss-btn mss-btn-primary"
          >
            Save configuration
          </button>
          <span id="status" class="status neutral"></span>
        </div>

        <div class="mss-muted mss-footnote">
          Changes are saved to <code>config.json</code> on the server. Test
          widgets will pick up the new settings on page refresh.
        </div>
      </section>

      <!-- RIGHT: EDITABLE FLAGS + RAW JSON -->
      <section class="mss-card">
        <header class="mss-card-header">
          <h2 class="mss-card-title">Editable fields</h2>
          <p class="mss-card-subtitle">
            Toggle which label fields are editable in widget/admin experiences
            (the <code>editable</code> map in <code>config.json</code>).
          </p>
        </header>

        <div id="editableContainer" class="pill-checkboxes">
  		<!-- dynamically filled with checkboxes from config.editable -->
	</div>

        <hr class="mss-divider" />

        <header class="mss-card-header mss-card-header-tight">
          <h2 class="mss-card-title">Raw config</h2>
          <p class="mss-card-subtitle">
            Read-only view of the current config as JSON (for sanity checks /
            support).
          </p>
        </header>

        <pre id="rawJson" class="mss-json-box">{}</pre>
      </section>
    </div>
  </main>

  <script>
    // --------- SERVICE_BASE detection (same pattern as Widget) ----------
    const SERVICE_BASE = (window.location.hostname.includes('localhost')
      ? 'http://localhost:3000'
      : 'https://msswidget-dev.onrender.com'
    ).replace(/\/+$/, '');

    const $ = (id) => document.getElementById(id);

    let CURRENT_CONFIG = null; // raw object as loaded

    function setStatus(msg, kind = 'neutral') {
      const el = $('status');
      if (!el) return;
      el.textContent = msg || '';
      el.className = 'status ' + kind;
    }

    function updateEnvTag() {
      const tag = $('envTag');
      if (!tag) return;
      const isLocal = window.location.hostname.includes('localhost');
      tag.textContent = isLocal ? 'LOCAL DEV' : 'RENDER PROD';
    }

    // --------- Load config from server ----------
    async function fetchConfig() {
      setStatus('Loading…', 'neutral');
      try {
        const res = await fetch(SERVICE_BASE + '/config/widget?ts=' + Date.now(), {
          cache: 'no-store',
        });
        if (!res.ok) {
          setStatus('Failed to load config (' + res.status + ')', 'err');
          return;
        }
        const cfg = await res.json();
        CURRENT_CONFIG = cfg;
        hydrateFormFromConfig(cfg);
        setStatus('Loaded', 'ok');
      } catch (e) {
        console.warn('fetchConfig error', e);
        setStatus('Network error while loading config', 'err');
      }
    }

    // --------- Fill the UI from config.json ----------
    function hydrateFormFromConfig(cfg) {
      // Theme
      $('theme').value = (cfg.theme || 'apple').toLowerCase();

      // Upload behaviour
      $('permitUpload').checked = cfg.Permitupload !== false; // default true

      // Audio bounds
      $('audioMin').value = Number(cfg.audioMinSeconds ?? 30);
      $('audioMax').value = Number(cfg.audioMaxSeconds ?? 61);

      // API
      const api = cfg.api || {};
      $('apiEnabled').checked = api.enabled !== false;
      $('apiBase').value = api.baseUrl || '';
      $('apiKey').value = api.key || '';
      $('apiSecret').value = api.secret || '';

      // Logger
      const logger = cfg.logger || {};
      $('logEnabled').checked = !!logger.enabled;
      $('logUrl').value = logger.url || '';

      // Editable map (generic)
      const editable = cfg.editable || {};
const container = $('editableContainer');
container.innerHTML = '';

Object.keys(editable).forEach((key) => {
  const checked = !!editable[key];
  const pill = document.createElement('label');

  // NOTE: both classes
  pill.className = 'pill-checkbox mss-chip';

  pill.innerHTML = `
    <input type="checkbox" data-editable-key="${key}" ${checked ? 'checked' : ''}/>
    <span>${key}</span>
  `;
  container.appendChild(pill);
});

      // Raw JSON
      $('rawJson').textContent = JSON.stringify(cfg, null, 2);
    }

    // --------- Build config object to send back ----------
    function buildConfigFromForm() {
      // Start from deep-ish copy of CURRENT_CONFIG so we preserve unknown keys
      const base = JSON.parse(JSON.stringify(CURRENT_CONFIG || {}));

      // Theme
      base.theme = $('theme').value || 'apple';

      // Upload behaviour
      base.Permitupload = $('permitUpload').checked;

      // Audio bounds
      const minS = Number($('audioMin').value || 0);
      const maxS = Number($('audioMax').value || 0);
      base.audioMinSeconds = Number.isFinite(minS) && minS >= 0 ? minS : 30;
      base.audioMaxSeconds = Number.isFinite(maxS) && maxS > 0 ? maxS : 61;

      // API
      base.api = base.api || {};
      base.api.enabled = $('apiEnabled').checked;
      base.api.baseUrl = $('apiBase').value.trim();
      base.api.key = $('apiKey').value.trim();
      base.api.secret = $('apiSecret').value.trim();

      // Logger
      base.logger = base.logger || {};
      base.logger.enabled = $('logEnabled').checked;
      base.logger.url = $('logUrl').value.trim();

      // Editable map
      base.editable = base.editable || {};
      const editInputs = document.querySelectorAll('[data-editable-key]');
      editInputs.forEach((input) => {
        const k = input.getAttribute('data-editable-key');
        base.editable[k] = input.checked;
      });

      return base;
    }

    // --------- Save config to server ----------
    async function saveConfig() {
      if (!CURRENT_CONFIG) {
        setStatus('No config loaded yet', 'err');
        return;
      }

      const payload = buildConfigFromForm();
      const adminKey = $('adminKey').value.trim();

      setStatus('Saving…', 'neutral');
      $('saveBtn').disabled = true;

      try {
        const headers = {
          'Content-Type': 'application/json',
        };
        if (adminKey) {
          headers['X-ADMIN-KEY'] = adminKey;
        }

        const res = await fetch(SERVICE_BASE + '/config/widget', {
          method: 'PUT',
          headers,
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          console.warn('Save failed', res.status, body);
          setStatus(
            'Save failed (' + res.status + '): ' + (body.error || 'Unknown error'),
            'err',
          );
          $('saveBtn').disabled = false;
          return;
        }

        const body = await res.json().catch(() => ({}));
        if (!body.ok) {
          setStatus('Save error: ' + (body.error || 'Unknown error'), 'err');
          $('saveBtn').disabled = false;
          return;
        }

        // Update in-memory copy & raw JSON
        CURRENT_CONFIG = payload;
        $('rawJson').textContent = JSON.stringify(payload, null, 2);
        setStatus('Saved', 'ok');
        $('saveBtn').disabled = false;
      } catch (e) {
        console.warn('saveConfig error', e);
        setStatus('Network error while saving config', 'err');
        $('saveBtn').disabled = false;
      }
    }

    // --------- Wire up events ----------
    window.addEventListener('DOMContentLoaded', () => {
      updateEnvTag();
      fetchConfig();

      $('reloadBtn').addEventListener('click', fetchConfig);
      $('saveBtn').addEventListener('click', saveConfig);
    });
  </script>
</body>
</html>