<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS Widget – Admin login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/themes/MSSStylesheet.css?v=1" />
  <link rel="stylesheet" href="/themes/mss-signup.css?v=1" />
</head>
<body class="mss-signup-body">
  <div class="mss-signup-shell">
    <header class="mss-signup-header">
      <div class="mss-signup-brand">
        <div class="mss-signup-mark">MSS</div>
        <div>
          <div class="mss-signup-brand-main">MSS Widget</div>
          <div class="mss-signup-brand-sub">
            Admin login
          </div>
        </div>
      </div>
    </header>

    <main class="mss-signup-main">
      <section class="mss-signup-card">
        <h1 class="mss-signup-title">Sign in to configure your widget</h1>
        <p class="mss-signup-tagline">
          Use the same email and password you used when you created your school.
        </p>

        <form id="loginForm" class="mss-signup-form">
          <label class="mss-signup-field">
            <span>Email</span>
            <input
              type="email"
              name="email"
              required
              placeholder="you@example.com"
            />
          </label>

          <label class="mss-signup-field">
            <span>Password</span>
            <input
              type="password"
              name="password"
              required
              placeholder="Your password"
            />
          </label>

          <button type="submit" class="mss-signup-submit">
            Sign in
          </button>

          <p id="loginStatus" class="mss-signup-status"></p>
        </form>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const form = document.getElementById("loginForm");
      const statusEl = document.getElementById("loginStatus");

      if (!form) return;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!statusEl) return;

        statusEl.textContent = "Signing in…";
        statusEl.className = "mss-signup-status mss-signup-status-working";

        const fd = new FormData(form);
        const payload = {
          email: (fd.get("email") || "").toString().trim(),
          password: (fd.get("password") || "").toString()
        };

        try {
          const res = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const body = await res.json().catch(() => ({}));

          if (!res.ok || !body.ok) {
            const msg =
              body.message ||
              body.error ||
              "Login failed. Check your email and password.";
            statusEl.textContent = msg;
            statusEl.className = "mss-signup-status mss-signup-status-error";
            return;
          }

          const { slug } = body;

          statusEl.textContent = "Login successful. Loading settings…";
          statusEl.className = "mss-signup-status mss-signup-status-ok";

          // Redirect to config admin for that school
          window.location = "/config-admin/?slug=" + encodeURIComponent(slug);
        } catch (err) {
          console.error("login error:", err);
          statusEl.textContent =
            "Network error during login. Please try again.";
          statusEl.className = "mss-signup-status mss-signup-status-error";
        }
      });
    })();
  </script>
</body>
</html>