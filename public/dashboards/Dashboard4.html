<!-- /public/dashboards/Dashboard4.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS – Speaking Result</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/themes/MSSStylesheet.css">
  <link rel="stylesheet" href="/themes/Dashboard.css">
</head>
<body>
  <div class="dash4-shell">
    <header class="dash4-header">
      <div>
        <h1 class="dash4-title">Your speaking result</h1>
        <p class="dash4-subtitle">
          This is your most recent score for today’s speaking task.
        </p>
      </div>
      <div id="dash4-badge" class="dash4-badge">
        CEFR snapshot
      </div>
    </header>

    <div class="dash4-main">
      <!-- Score side -->
      <section class="dash4-score-card">
        <div class="dash4-score-label">Overall level</div>
        <div class="dash4-score-circle">
          <span id="dash4-cefr-letter" class="dash4-score-letter">–</span>
        </div>
        <div id="dash4-cefr-label" class="dash4-score-desc">
          We’re loading your score…
        </div>
        <div id="dash4-question" class="dash4-question"></div>
      </section>

      <!-- CTA side -->
      <section class="dash4-cta">
        <h2 class="dash4-cta-title">Get your free detailed report</h2>
        <p id="dash4-cta-message" class="dash4-cta-text">
          We’re preparing a short summary you can share with your teacher.
        </p>

        <div class="dash4-button-row">
          <button id="dash4-cta-button" class="dash4-primary-btn" disabled>
            Continue to my free report
          </button>
          <span id="dash4-secondary" class="dash4-secondary-link">
            Close this window
          </span>
        </div>

        <p id="dash4-cta-hint" class="dash4-cta-hint">
          Your teacher will receive a copy of this result so you can track progress together.
        </p>

        <div id="dash4-error" class="dash4-error" style="display:none;"></div>
      </section>
    </div>

    <footer class="dash4-footer">
      <span id="dash4-meta">Powered by MSS Vox</span>
      <span>CEFR-aligned feedback • 30–60 second practice</span>
    </footer>
  </div>

  <script>
    (function () {
      "use strict";

      const $ = (id) => document.getElementById(id);

      const cefrLetterEl = $("dash4-cefr-letter");
      const cefrLabelEl  = $("dash4-cefr-label");
      const questionEl   = $("dash4-question");
      const ctaMsgEl     = $("dash4-cta-message");
      const ctaBtnEl     = $("dash4-cta-button");
      const ctaHintEl    = $("dash4-cta-hint");
      const secondaryEl  = $("dash4-secondary");
      const errorEl      = $("dash4-error");
      const badgeEl      = $("dash4-badge");
      const metaEl       = $("dash4-meta");

      const params = new URLSearchParams(window.location.search);
      const slug = (params.get("slug") || "mss-demo").trim();
      const subIdParam = params.get("submissionId") || params.get("id");
      const submissionId = subIdParam ? Number(subIdParam) : null;

      if (badgeEl && slug) {
        badgeEl.textContent = `CEFR snapshot • ${slug}`;
      }

      function setError(msg) {
        if (!errorEl) return;
        errorEl.textContent = msg || "Something went wrong loading your result.";
        errorEl.style.display = "block";
      }

      function describeCEFR(cefr) {
        const map = {
          A1: "Beginner",
          A2: "Elementary",
          B1: "Intermediate",
          B2: "Upper-intermediate",
          C1: "Advanced",
          C2: "Proficiency",
        };
        return map[cefr] || "Speaking level";
      }

      function shortenQuestion(q) {
        if (!q) return "";
        const s = String(q).trim().replace(/\s+/g, " ");
        return s.length > 140 ? s.slice(0, 137) + "…" : s;
      }

      // Close / secondary action
      if (secondaryEl) {
        secondaryEl.addEventListener("click", () => {
          if (window.opener) {
            window.close();
          } else if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "/";
          }
        });
      }

      // Load result + config
      Promise.all([
        fetch(`/api/dashboard/submissions?slug=${encodeURIComponent(slug)}&limit=50`)
          .then((r) => r.json())
          .catch(() => ({ ok: false })),
        fetch(`/api/admin/widget/${encodeURIComponent(slug)}`)
          .then((r) => r.json())
          .catch(() => ({})),
      ])
        .then(([subRes, widgetRes]) => {
          // ----- submissions -----
          if (!subRes || subRes.ok === false) {
            setError("We couldn’t load your latest result. Please try again.");
            cefrLabelEl.textContent = "Result unavailable.";
            return;
          }

          const rows = Array.isArray(subRes.rows)
            ? subRes.rows
            : subRes.tests || [];

          if (!rows.length) {
            setError("No speaking results found yet.");
            cefrLetterEl.textContent = "–";
            cefrLabelEl.textContent = "Take a test to see your level.";
            return;
          }

          let row = rows[0];
          if (submissionId && Number.isFinite(submissionId)) {
            const found = rows.find((r) => Number(r.id) === submissionId);
            if (found) row = found;
          }

          const cefrRaw = row.mss_cefr || row.cefr || "";
          const cefr = String(cefrRaw || "").toUpperCase();
          const letter = cefr || "–";

          cefrLetterEl.textContent = letter;
          cefrLabelEl.textContent = cefr
            ? `${cefr} – ${describeCEFR(cefr)} level`
            : "We could not derive your CEFR level from this test.";

          const q = shortenQuestion(row.question || "");
          if (q && questionEl) {
            questionEl.innerHTML = `<strong>Question:</strong> ${q}`;
          }

          if (metaEl && row.submitted_at) {
            metaEl.textContent =
              "Powered by MSS Vox • " +
              new Date(row.submitted_at).toLocaleString();
          }

          // ----- config for after-dashboard CTA -----
          const cfgRoot =
            (widgetRes.settings && widgetRes.settings.config)
              ? widgetRes.settings.config
              : (widgetRes.config || {});

          // Support new nested structure: config.afterDashboard.signupUrl / ctaMessage
          const afterDash = cfgRoot.afterDashboard || {};

          let signupUrl =
            afterDash.signupUrl ||
            afterDash.signup_url ||
            cfgRoot.afterDashboardSignupUrl ||
            cfgRoot.after_dashboard_signup_url ||
            "";

          const ctaMessage =
            afterDash.ctaMessage ||
            afterDash.message ||
            afterDash.cta_message ||
            cfgRoot.afterDashboardCtaMessage ||
            cfgRoot.after_dashboard_cta_message ||
            "Get a free, detailed speaking report and advice from one of our teachers.";

          if (ctaMsgEl) {
            ctaMsgEl.textContent = ctaMessage;
          }

          if (signupUrl) {
            // Normalize relative URLs against current origin
            try {
              const u = new URL(signupUrl, window.location.origin);
              signupUrl = u.toString();
            } catch (_) {
              // if URL constructor fails, fall back to raw string
            }

            if (ctaBtnEl) {
              ctaBtnEl.disabled = false;
              ctaBtnEl.addEventListener("click", () => {
                window.location.href = signupUrl;
              });
            }

            if (ctaHintEl) {
              ctaHintEl.textContent =
                "Click the button above to go to your school’s signup page and receive your full report.";
            }
          } else {
            // No signup URL configured
            if (ctaBtnEl) {
              ctaBtnEl.disabled = true;
            }
            if (ctaHintEl) {
              ctaHintEl.textContent =
                "Ask your school how to receive a full speaking report linked to this result.";
            }
          }
        })
        .catch((err) => {
          console.error("Dashboard4 load error:", err);
          setError("We couldn’t load your result. Please try again.");
        });
    })();
  </script>
</body>
</html>