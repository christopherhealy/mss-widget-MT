<!-- /public/dashboards/Dashboard5.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS â€“ Speaking Result</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/themes/MSSStylesheet.css">
  <link rel="stylesheet" href="/themes/Dashboard.css">
</head>
<body class="dash5-body">

<script>
  // Backend base used by this dashboard:
  //   - Local dev / Render app: same origin ("")
  //   - Vercel: go to Render backend directly
  (function () {
    const host = window.location.hostname || "";
    let base = "";

    if (host.endsWith(".vercel.app") || host.includes("mss-widget")) {
      base = "https://mss-widget-mt.onrender.com";
    }

    window.MSS_BACKEND_BASE = base;
    console.log("ðŸ”§ Dashboard5 MSS_BACKEND_BASE =", base || "(same origin)");
  })();
</script>

  <div class="dash5-shell">
    <!-- Header -->
    <header class="dash5-header">
      <div>
        <h1 class="dash5-title">Your speaking result</h1>
        <p class="dash5-subtitle">
          This is your most recent score for todayâ€™s speaking task.
        </p>
      </div>
      <div id="dash5-badge" class="dash5-badge">
        CEFR snapshot
      </div>
    </header>

    <div class="dash5-main">
      <!-- Score side -->
      <section class="dash5-score-card">
        <div class="dash5-score-label">Overall level</div>
        <div class="dash5-score-circle">
          <span id="dash5-cefr-letter" class="dash5-score-letter">â€“</span>
        </div>
        <div id="dash5-cefr-label" class="dash5-score-desc">
          Weâ€™re loading your scoreâ€¦
        </div>
        <div id="dash5-question" class="dash5-question"></div>
      </section>

      <!-- CTA side -->
      <section class="dash5-cta">
        <h2 class="dash5-cta-title">Get your free detailed report</h2>
        <p id="dash5-cta-message" class="dash5-cta-text">
          Weâ€™re preparing a short summary you can share with your teacher.
        </p>

        <div class="dash5-button-row">
          <button id="dash5-cta-button" class="dash5-primary-btn" disabled>
            Continue to my free report
          </button>
          <span id="dash5-secondary" class="dash5-secondary-link">
            Close this window
          </span>
        </div>

        <p id="dash5-cta-hint" class="dash5-cta-hint">
          Your teacher will receive a copy of this result so you can track progress together.
        </p>

        <div id="dash5-error" class="dash5-error" style="display:none;"></div>
      </section>
    </div>

    <footer class="dash5-footer">
      <span id="dash5-meta">Powered by MSS Vox</span>
      <span>CEFR-aligned feedback â€¢ 30â€“60 second practice</span>
    </footer>
  </div>

  <script>
    (function () {
      "use strict";

      const $ = (id) => document.getElementById(id);

      const cefrLetterEl = $("dash5-cefr-letter");
      const cefrLabelEl  = $("dash5-cefr-label");
      const questionEl   = $("dash5-question");
      const ctaMsgEl     = $("dash5-cta-message");
      const ctaBtnEl     = $("dash5-cta-button");
      const ctaHintEl    = $("dash5-cta-hint");
      const secondaryEl  = $("dash5-secondary");
      const errorEl      = $("dash5-error");
      const badgeEl      = $("dash5-badge");
      const metaEl       = $("dash5-meta");

      const params = new URLSearchParams(window.location.search);
      const slug = (params.get("slug") || "mss-demo").trim();
      const subIdParam = params.get("submissionId") || params.get("id");
      const submissionId = subIdParam ? Number(subIdParam) : null;

      // Backend base ("" = same origin)
      const API_BASE = (window.MSS_BACKEND_BASE || "").replace(/\/+$/, "");
      const reportsUrl = `${API_BASE}/api/admin/reports/${encodeURIComponent(slug)}?limit=50`;
      const widgetUrl  = `${API_BASE}/api/admin/widget/${encodeURIComponent(slug)}`;

      if (badgeEl && slug) {
        badgeEl.textContent = `CEFR snapshot â€¢ ${slug}`;
      }

      function setError(msg) {
        if (!errorEl) return;
        errorEl.textContent = msg || "Something went wrong loading your result.";
        errorEl.style.display = "block";
      }

      function describeCEFR(cefr) {
        const map = {
          A1: "Beginner",
          A2: "Elementary",
          B1: "Intermediate",
          B2: "Upper-intermediate",
          C1: "Advanced",
          C2: "Proficiency",
        };
        return map[cefr] || "Speaking level";
      }

      function shortenQuestion(q) {
        if (!q) return "";
        const s = String(q).trim().replace(/\s+/g, " ");
        return s.length > 140 ? s.slice(0, 137) + "â€¦" : s;
      }

      // Close / secondary action
      if (secondaryEl) {
        secondaryEl.addEventListener("click", () => {
          if (window.opener) {
            window.close();
          } else if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "/";
          }
        });
      }

      // Load latest submission + widget config
      console.log("ðŸ“¡ Dashboard5 fetching:", { reportsUrl, widgetUrl });

      Promise.all([
        // Use the same reports endpoint as other dashboards
        fetch(reportsUrl)
          .then((r) => r.json())
          .catch((err) => {
            console.error("Dashboard5 reports fetch error:", err);
            return { ok: false };
          }),

        fetch(widgetUrl)
          .then((r) => r.json())
          .catch((err) => {
            console.warn("Dashboard5 widget fetch error:", err);
            return {};
          }),
      ])
        .then(([subRes, widgetRes]) => {
          // ----- submissions -----
          if (!subRes || subRes.ok === false) {
            setError("We couldnâ€™t load your latest result. Please try again.");
            if (cefrLabelEl) {
              cefrLabelEl.textContent = "Result unavailable.";
            }
            return;
          }

          const rows = Array.isArray(subRes.rows)
            ? subRes.rows
            : subRes.tests || [];

          if (!rows.length) {
            setError("No speaking results found yet.");
            if (cefrLetterEl) cefrLetterEl.textContent = "â€“";
            if (cefrLabelEl) {
              cefrLabelEl.textContent = "Take a test to see your level.";
            }
            return;
          }

          let row = rows[0];
          if (submissionId && Number.isFinite(submissionId)) {
            const found = rows.find((r) => Number(r.id) === submissionId);
            if (found) row = found;
          }

          const cefrRaw = row.mss_cefr || row.cefr || "";
          const cefr = String(cefrRaw || "").toUpperCase();
          const letter = cefr || "â€“";

          if (cefrLetterEl) cefrLetterEl.textContent = letter;
          if (cefrLabelEl) {
            cefrLabelEl.textContent = cefr
              ? `${cefr} â€“ ${describeCEFR(cefr)} level`
              : "We could not derive your CEFR level from this test.";
          }

          const q = shortenQuestion(row.question || "");
          if (q && questionEl) {
            questionEl.innerHTML = `<strong>Question:</strong> ${q}`;
          }

          if (metaEl && row.submitted_at) {
            metaEl.textContent =
              "Powered by MSS Vox â€¢ " +
              new Date(row.submitted_at).toLocaleString();
          }

          // ----- config for after-dashboard CTA -----
          const cfgRoot =
            (widgetRes.settings && widgetRes.settings.config)
              ? widgetRes.settings.config
              : (widgetRes.config || {});

          const afterDash = cfgRoot.afterDashboard || {};

          // Flexible key support
          let signupUrl =
            afterDash.signupUrl ||
            afterDash.signup_url ||
            cfgRoot.afterDashboardSignupUrl ||
            cfgRoot.after_dashboard_signup_url ||
            "";

          const ctaMessage =
            afterDash.ctaMessage ||
            afterDash.message ||
            afterDash.cta_message ||
            cfgRoot.afterDashboardCtaMessage ||
            cfgRoot.after_dashboard_cta_message ||
            "Get a free, detailed speaking report and advice from one of our teachers.";

          if (ctaMsgEl) {
            ctaMsgEl.textContent = ctaMessage;
          }

          if (signupUrl) {
            // Normalize relative URLs
            try {
              const u = new URL(signupUrl, window.location.origin);
              signupUrl = u.toString();
            } catch (_) {
              // fall back to raw string
            }

            if (ctaBtnEl) {
              ctaBtnEl.disabled = false;
              ctaBtnEl.addEventListener("click", () => {
                window.location.href = signupUrl;
              });
            }

            if (ctaHintEl) {
              ctaHintEl.textContent =
                "Click the button above to go to your schoolâ€™s signup page and receive your full report.";
            }
          } else {
            // No signup URL configured
            if (ctaBtnEl) {
              ctaBtnEl.disabled = true;
            }
            if (ctaHintEl) {
              ctaHintEl.textContent =
                "Ask your school how to receive a full speaking report linked to this result.";
            }
          }
        })
        .catch((err) => {
          console.error("Dashboard5 load error:", err);
          setError("We couldnâ€™t load your result. Please try again.");
        });
    })();
  </script>

  <!-- Optional: still fine to keep dashboard-core.js if youâ€™re using it elsewhere -->
  <script src="/js/dashboard-core.js" defer></script>
</body>
</html>