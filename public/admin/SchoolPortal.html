<!-- /admin/SchoolPortal.html — v0.6 Portal, Build: 2025-11-30 -->
<!-- TEST-WWCD-PORTAL V2-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS School Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/themes/MSSStylesheet.css" />
  <link rel="stylesheet" href="/themes/SchoolPortal.css" />
</head>
<body>

  <div class="portal-shell">
    <header class="portal-header">
      <div class="portal-header-main">
        <h1 id="portal-title">School Portal</h1>
        <p id="portal-subtitle">
          Manage your questions, widget, dashboard, and reports.
        </p>

        <div class="portal-badges">
          <span id="portal-slug-badge" class="badge badge-soft">slug: —</span>
          <span id="portal-assessment-label" class="badge badge-outline">
            Assessment: —
          </span>
        </div>

        <div class="portal-school-picker">
          <label for="portal-school-selector" class="portal-school-label">
            School:
          </label>
          <select id="portal-school-selector" class="portal-school-select">
            <option value="">Loading schools…</option>
          </select>
        </div>
      </div>
    </header>

    <!-- Quick access cards -->
    <div class="portal-quick-links">
      <div class="grid">
        <!-- Left: Widget & Reports -->
        <div class="column">
          <!-- Widget & Dashboard card -->
          <section class="card">
            <div class="card-header">
              <div class="card-title">Widget & Dashboard</div>
              <div class="card-actions">
                <button class="btn" id="btn-widgetSurvey">Open Question Editor</button>
                <button class="btn" id="btn-configAdmin">Open Config Admin</button>

                <button id="btnPromptManager" class="btn btn-sm" type="button">
                  AI Prompt Manager
                </button>

                <div class="portal-top-actions">
                  <button id="openReportsBtn" class="btn">View reports</button>
                </div>
                <!-- New: logout Dec 4 
                 <button id="portal-logout" class="btn btn-ghost">
                  Log out as Admin
                </button    -->
                    <button id="btn-admin-home" class="btn" type="button" 
                         title="Return to Admin Home">
                           Admin Home
                     </button>
              </div>
            </div>

            <div class="portal-tab-row">
              <div class="widget-preview-tabs">
                <button
                  class="widget-preview-tab active"
                  data-target="widget"
                  id="tab-widget">
                  Show Widget
                </button>
                <button
                  class="widget-preview-tab"
                  data-target="dashboard"
                  id="tab-dashboard">
                  Show Dashboard
                </button>
              </div>              
            </div>

            <div class="widget-frame">
              <iframe id="portal-iframe" src="about:blank"></iframe>
            </div>

            <!-- Embed snippet card -->
            <section class="portal-embed">
              <div class="embed-snippet">
                <div class="embed-snippet-label">Embed snippet for your school website</div>
                <p class="embed-snippet-help muted">
                  Paste this code into any page on your site where you want the speaking test
                  to appear. It loads the widget automatically and adjusts its height as students
                  move through the questions.
                </p>
                <textarea id="embed-snippet" readonly></textarea>

                <div style="margin-top:4px;display:flex;justify-content:flex-end;">
                  <button class="btn" id="btn-copy-embed">Copy embed code</button>
                </div>
              </div>
            </section>

            <!-- Reports card -->
            <section class="card" style="margin-top:14px;" data-role="tests-card">
              <div class="card-header">
                <div class="card-title">Test Results</div>
                <div class="card-actions">
                  <button class="btn" id="btn-refresh-tests">
                    <span class="muted">Refresh</span>
                  </button>
                  <button class="btn btn-primary" id="btn-download-csv" type="button">
                    Download CSV
                  </button>
                  <button class="btn btn-danger" id="btn-delete-selected" type="button">
                    Delete Selected
                  </button>
                </div>
              </div>

              <div class="filters-row">
                <label>
                  From
                  <input type="date" id="filter-from" />
                </label>
                <label>
                  To
                  <input type="date" id="filter-to" />
                </label>
                <span class="muted" id="tests-count-label">0 tests</span>
              </div>

              <div class="tests-table-wrapper">
                <table class="tests-table" id="tests-table">
                  <thead>
                    <tr>
                      <th data-sortable="false">Select</th>
                      <th data-sortable="false">Actions</th>
                      <th data-sort-key="id">ID</th>
                      <th data-sort-key="date">Date</th>
                      <th data-sort-key="student">Student</th>
                      <th data-sort-key="question">Question</th>
                      <th data-sort-key="wpm">WPM</th>
                      <th data-sort-key="toefl">TOEFL</th>
                      <th data-sort-key="ielts">IELTS</th>
                      <th data-sort-key="pte">PTE</th>
                      <th data-sort-key="cefr">CEFR</th>
                      <th data-sort-key="help">Help</th>
                      <th data-sort-key="dash">Dash</th>
                      <th data-sort-key="fluency">Fluency</th>
                      <th data-sort-key="grammar">Grammar</th>
                      <th data-sort-key="pron">Pron.</th>
                      <th data-sort-key="vocab">Vocab</th>
                    </tr>
                  </thead>
                  <tbody id="tests-tbody">
                    <tr><td colspan="17" class="muted">No data yet.</td></tr>
                  </tbody>
                </table>
              </div>
            </section>
          </section>
        </div>

        <!-- Right: Stats -->
        <div class="column">
          <section class="card">
            <div class="card-header">
              <div class="card-title">Activity Snapshot</div>
              <div class="timeframe-toggle" id="timeframe-toggle">
                <button class="timeframe-btn active" data-range="today">Today</button>
                <button class="timeframe-btn" data-range="week">This Week</button>
                <button class="timeframe-btn" data-range="month">This Month</button>
                <button class="timeframe-btn" data-range="year">This Year</button>
              </div>
            </div>

            <div id="stats-loading" class="muted">
              <span class="spinner"></span> Fetching stats…
            </div>

            <div id="stats-content" style="display:none;">
              <div class="muted" id="stats-range-label"></div>

              <div class="stats-row" style="margin-top:6px;">
                <div class="stat-pill">
                  <div class="stat-label">Total tests</div>
                  <div class="stat-value" id="stat-totalTests">—</div>
                </div>
                <div class="stat-pill">
                  <div class="stat-label">Most popular question</div>
                  <div class="stat-value" id="stat-topQuestion">—</div>
                </div>
              </div>

              <div class="stats-row">
                <div class="stat-pill">
                  <div class="stat-label">Highest CEFR</div>
                  <div class="stat-value" id="stat-highestCEFR">—</div>
                </div>
                <div class="stat-pill">
                  <div class="stat-label">Lowest CEFR</div>
                  <div class="stat-value" id="stat-lowestCEFR">—</div>
                </div>
                <div class="stat-pill">
                  <div class="stat-label">Average CEFR</div>
                  <div class="stat-value" id="stat-avgCEFR">—</div>
                </div>
              </div>
            </div>
          </section>
        </div>

      </div>
    </div>
  </div>

  <!-- Tiny helper: "View reports" scrolls to Test Results card -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const openReportsBtn = document.getElementById("openReportsBtn");
      const testsCard = document.querySelector('[data-role="tests-card"]');

      if (openReportsBtn && testsCard) {
        openReportsBtn.addEventListener("click", () => {
          testsCard.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      }
    });
  </script>

  <!-- Styled Warning Modal -->
  <div id="portal-warning-backdrop" class="portal-warning-backdrop hidden">
    <div class="portal-warning-modal">
      <div class="modal-title">⚠️ Warning</div>
      <div class="modal-message" id="portal-warning-message">
        Something went wrong.
      </div>
      <button class="modal-btn" id="portal-warning-ok">OK</button>
    </div>
  </div>

  <!-- Transcript modal -->
  <div id="portal-transcript-backdrop" class="sp-modal-backdrop hidden">
    <div class="sp-modal">
      <header class="sp-modal-header">
        <div class="sp-modal-titleblock">
          <h2 id="portal-transcript-title" class="sp-modal-title"></h2>
          <p id="portal-transcript-subtitle" class="sp-modal-subtitle"></p>
        </div>
        <button type="button" id="portal-transcript-close" class="sp-modal-close">×</button>
      </header>

      <main id="portal-transcript-body" class="sp-modal-body"></main>

      <footer class="sp-modal-footer">
        <button class="mss-btn" data-copy-modal>
          Copy to Clipboard
        </button>

        <button
          type="button"
          id="portal-transcript-ok"
          class="mss-btn mss-btn-primary"
        >
          Close
        </button>
      </footer>
    </div>
  </div>

  <!-- Delete confirmation modal -->
  <div id="portal-delete-backdrop" class="portal-warning-backdrop hidden">
    <div class="portal-warning-modal">
      <div class="modal-title">Delete submissions?</div>
      <div class="modal-message" id="portal-delete-message">
        Are you sure you want to delete these submissions? This cannot be undone.
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
        <button
          type="button"
          class="modal-btn"
          id="portal-delete-cancel"
          style="background:#6b7280;"
        >
          Cancel
        </button>
        <button
          type="button"
          class="modal-btn"
          id="portal-delete-confirm"
        >
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Dashboard preview modal -->
  <div id="dashboardModal" class="portal-modal hidden">
    <div class="dashboard-modal-shell">
      <div class="dashboard-modal-dialog">
        <!-- Top panel: title + layout select + X -->
        <header class="dashboard-modal-header">
          <h2 class="dashboard-modal-title">Dashboard view</h2>

          <!-- no label, just the select -->
          <select id="dashboardLayoutSelect" class="dashboard-layout-select"></select>

          <button
            id="dashboardModalClose"
            class="dashboard-modal-close"
            type="button"
            aria-label="Close dashboard view"
          >
            ×
          </button>
        </header>

        <!-- Middle panel: iframe in a padded shell -->
        <main class="dashboard-modal-main">
          <div class="dashboard-frame-shell">
            <iframe
              id="dashboardPreviewFrame"
              src=""
              allow="fullscreen"
              referrerpolicy="no-referrer"
            ></iframe>
          </div>
        </main>

        <!-- Bottom panel: actions -->
        <footer class="dashboard-modal-footer">
          <button id="dashboardReloadBtn" type="button">Reload</button>
          <button id="dashboardPrintBtn" type="button">Print</button>
          <button id="dashboardCloseBtn" class="btn-primary" type="button">
            Close
          </button>
        </footer>
      </div>
    </div>
  </div>

<!-- REPORT VIEWER (Generate Report) -->
<div id="reportOverlay" class="sp-modal-backdrop hidden" aria-hidden="true">
  <div class="sp-modal report-modal" role="dialog" aria-modal="true" aria-label="Report Viewer">

    <!-- Header -->
    <div class="mHead report-head">
      <div class="report-head-left">
        <div class="mTitle" id="reportTitle">Generate Report</div>
        <div class="meta report-meta" id="reportMeta"></div>
      </div>

      <div class="report-head-right">
        <button class="iconBtn" id="reportCloseX" type="button" aria-label="Close">✕</button>
      </div>
    </div>

    <!-- Body -->
    <div class="mBody report-body">

      <!-- Controls -->
      <div class="report-controls">
        <div class="report-field">
          <label class="report-label" for="aiPromptSelect">AI Prompt</label>
          <select id="aiPromptSelect" class="select report-select"></select>
          <div class="hint" id="aiPromptHint">Choose a prompt template for this report.</div>
        </div>

        <div class="report-actions">
          <button id="btnRunReport" class="btn primary" type="button">Generate</button>
          <button id="btnReportClose" class="btn" type="button">Close</button>
          <button id="btnReportCopy" class="btn" type="button" data-copy-modal>Copy</button>

          <button id="btnReportDelete" class="btn danger" type="button" style="display:none;">
            Delete this report
          </button>
        </div>
      </div>

      <!-- Status -->
      <div id="reportStatus" class="status report-status" aria-live="polite"></div>

      <!-- Output -->
      <div class="card report-card">
        <div id="reportOutput" class="viewerText report-output"></div>
      </div>

    </div>
  </div>
</div>


  <!-- Single include of SchoolPortal.js -->
  <script src="/admin/SchoolPortal.js"></script>
</body>
</html>