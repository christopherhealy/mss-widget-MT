<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MSS Widget – Admin</title>

  <!-- Shared MSS design system -->
  <link rel="stylesheet" href="themes/MSSStylesheet.css" />
</head>
<body class="mss-root">

  <!-- Top bar -->
  <header class="mss-top">
    <div class="mss-top-inner mss-row">
      <div class="mss-stack-tight">
        <div class="mss-title">MSS Widget – Admin</div>
        <div class="mss-subtext">
          Edit widget text, theme, logo, logging, and audio limits used by the student widget.
        </div>
      </div>

      <div class="mss-admin-nav">
        <button id="openWidget" class="mss-btn mss-btn-ghost">Open Widget</button>
        <button id="openSurvey" class="mss-btn mss-btn-ghost">Open Survey Admin</button>
        <button id="saveAllTop" class="mss-btn mss-btn-primary">Save All Changes</button>
      </div>
    </div>
  </header>

  <main class="mss-shell">
    <div class="mss-layout">

      <!-- LEFT: Controls -->
      <section class="mss-card mss-accordion">
        <header class="mss-card-header">
          <h2 class="mss-card-title">Widget Configuration</h2>
          <p class="mss-card-subtitle">
            These settings are stored in <code>form.json</code>, <code>config.json</code> and
            <code>image.json</code> on the MSS service.
          </p>
        </header>

        <!-- Text & Flow -->
        <details class="mss-section" open>
          <summary class="mss-section-header">
            <span class="mss-chevron">▶</span>
            <span>Text &amp; Flow</span>
          </summary>
          <div class="mss-section-body">
            <div id="labels"></div>
          </div>
        </details>

        <!-- Theme & Branding -->
        <details class="mss-section" open>
          <summary class="mss-section-header">
            <span class="mss-chevron">▶</span>
            <span>Theme &amp; Branding</span>
            <span class="mss-pill">visual</span>
          </summary>
          <div class="mss-section-body">

            <div class="mss-field">
              <label class="mss-label" for="theme">Theme</label>
              <select id="theme" class="mss-input">
                <option value="apple">Apple</option>
                <option value="google">Google</option>
                <option value="midnight">Midnight</option>
              </select>
              <div class="mss-muted">
                Maps to <code>config.theme</code>. The widget chooses a CSS file based on this.
              </div>
            </div>

            <div class="mss-field">
              <label class="mss-label">Logo image</label>

              <div class="mss-logo-well">
                <img id="logoPreview" alt="Logo preview" />
              </div>

              <div class="mss-row-tight mss-file-row">
                <label class="mss-file-btn">
                  <span>Choose logo…</span>
                  <input id="logoFile" type="file" accept="image/*" />
                </label>
                <span id="logoFileName" class="mss-file-label">No file chosen</span>

                <button id="clearLogo" type="button" class="mss-btn mss-btn-ghost">
                  Remove Logo
                </button>
              </div>

              <div class="mss-muted">
                Stored as <code>image.json.logoDataUrl</code>. Displayed at the top of the widget.
              </div>
            </div>

          </div>
        </details>

        <!-- Logging & Audio -->
        <details class="mss-section" open>
          <summary class="mss-section-header">
            <span class="mss-chevron">▶</span>
            <span>Logging &amp; Audio</span>
            <span class="mss-pill mss-pill-soft">usage</span>
          </summary>
          <div class="mss-section-body">
            <div class="mss-field">
              <label class="mss-label" for="cfgLogUrl">Submission Logger URL</label>
              <input
                id="cfgLogUrl"
                type="url"
                class="mss-input"
                placeholder="https://mss-widget-mt.onrender.com/log/submission"
              />
              <div class="mss-muted">
                The widget posts submissions here. Typically your Render service
                <code>/log/submission</code>.
              </div>
            </div>

            <div class="mss-field mss-field-row">
              <div class="mss-field-half">
                <label class="mss-label" for="cfgMinS">Minimum recording (seconds)</label>
                <input id="cfgMinS" type="number" min="5" max="300" class="mss-input" />
              </div>
              <div class="mss-field-half">
                <label class="mss-label" for="cfgMaxS">Maximum recording (seconds)</label>
                <input id="cfgMaxS" type="number" min="10" max="600" class="mss-input" />
              </div>
            </div>

            <div class="mss-muted">
              Maps to <code>config.audioMinSeconds</code> and
              <code>config.audioMaxSeconds</code>. The widget enforces these ranges when recording.
            </div>
          </div>
        </details>

        <!-- Admin & JSON -->
        <details class="mss-section">
          <summary class="mss-section-header">
            <span class="mss-chevron">▶</span>
            <span>Admin &amp; JSON Files</span>
          </summary>
          <div class="mss-section-body">

            <div class="mss-field">
              <label class="mss-label" for="adminKey">Admin write key</label>
              <input
                id="adminKey"
                type="password"
                class="mss-input"
                placeholder="X-ADMIN-KEY header"
              />
              <div class="mss-muted">
                Must match <code>ADMIN_WRITE_KEY</code> on the server.
                Required for saving JSON back to the service.
              </div>
            </div>

            <div class="mss-field">
              <div class="mss-label">JSON files on the service</div>
              <ul class="mss-list">
                <li><code>src/form.json</code> – widget wording and survey questions</li>
                <li><code>src/config.json</code> – theme, audio limits, logger URL, etc.</li>
                <li><code>src/image.json</code> – logo image data</li>
              </ul>
              <div class="mss-muted">
                This screen edits only widget-facing values. API keys, secrets, and back-end
                config live in <strong>ConfigAdmin</strong>.
              </div>
            </div>

          </div>
        </details>

        <div class="mss-actions-bottom">
          <button id="saveAllBottom" class="mss-btn mss-btn-primary mss-btn-wide">
            Save All Changes
          </button>
        </div>
      </section>

      <!-- RIGHT: Preview -->
      <section class="mss-card mss-preview-shell">
        <header class="mss-card-header">
          <h2 class="mss-card-title">Live Preview</h2>
          <p class="mss-card-subtitle">
            This approximates what students see in the widget (without audio behaviour).
          </p>
        </header>

        <div class="mss-preview-card">
          <div class="mss-preview-head">
            <img id="pvLogo" class="mss-preview-logo" alt="Logo" />
            <div>
              <div id="pvBrand" class="mss-preview-brand">Your School</div>
              <div id="pvCounter" class="mss-preview-counter">Question 1 of 4</div>
            </div>
          </div>

          <div id="pvQ" class="mss-preview-question">
            Describe a memorable teacher you have had and explain why they were memorable.
          </div>

          <div class="mss-preview-nav">
            <button id="pvPrev" type="button" class="mss-btn mss-preview-pill">
              ← Previous
            </button>
            <button id="pvNext" type="button" class="mss-btn mss-preview-pill">
              Next →
            </button>
          </div>

          <div class="mss-preview-actions">
            <div class="mss-preview-toolbar">
              <button id="pvRecLabel" type="button" class="mss-btn mss-btn-primary">
                Record your response
              </button>
              <button id="pvStopLabel" type="button" class="mss-btn">
                Stop
              </button>
              <button id="pvUploadLabel" type="button" class="mss-btn">
                Choose an audio file
              </button>
              <button id="pvSubmitLabel" type="button" class="mss-btn">
                Submit for scoring
              </button>
            </div>

            <div class="mss-preview-recbar">
              <span class="mss-preview-dot"></span>
              <span id="pvRecState" class="mss-muted">Not recording</span>
            </div>
          </div>

          <div class="mss-preview-footer">
            <div id="pvPowered" class="mss-muted">Powered by MSS Vox</div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Save dialog -->
  <div id="dlgBack" class="mss-dialog-backdrop" hidden>
    <div class="mss-dialog">
      <div class="mss-dialog-title">Save configuration</div>
      <div id="dlgText" class="mss-dialog-body">
        Saving settings…
      </div>
      <div class="mss-dialog-actions">
        <button id="dlgCancel" class="mss-btn mss-btn-ghost">Cancel</button>
        <button id="dlgConfirm" class="mss-btn mss-btn-primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="mss-toast" hidden></div>

  <script>
    /* ---------- helpers & globals ---------- */
    const $ = (id) => document.getElementById(id);

    const SERVICE_BASE = window.location.hostname.includes("localhost")
      ? "http://localhost:3000"
      : "https://mss-widget-mt.onrender.com";

    let FORM = null;
    let CONFIG = null;
    let IMAGES = null;

    /* ---------- toast ---------- */
    function toast(msg, kind = "ok") {
      const el = $("toast");
      if (!el) return;
      el.textContent = msg;
      el.dataset.kind = kind;
      el.hidden = false;
      el.classList.add("mss-toast-show");
      setTimeout(() => {
        el.classList.remove("mss-toast-show");
        el.hidden = true;
      }, 2600);
    }

    /* ---------- dialog ---------- */
    function showDialog(text, onConfirm) {
      const back = $("dlgBack");
      const body = $("dlgText");
      const ok = $("dlgConfirm");
      const cancel = $("dlgCancel");
      if (!back || !body || !ok || !cancel) return;

      body.textContent = text;
      back.hidden = false;

      function close() {
        back.hidden = true;
        ok.onclick = null;
        cancel.onclick = null;
        back.onclick = null;
        document.removeEventListener("keydown", onKey);
      }

      function onKey(e) {
        if (e.key === "Escape") {
          e.preventDefault();
          close();
        }
      }

      // buttons
      cancel.onclick = close;
      ok.onclick = () => {
        close();
        onConfirm && onConfirm();
      };

      // click backdrop to close
      back.onclick = (e) => {
        if (e.target === back) {
          close();
        }
      };

      // esc key
      document.addEventListener("keydown", onKey);
    }

    /* ---------- build text / survey controls ---------- */
    function buildLabels() {
      const container = $("labels");
      if (!container || !FORM) return;
      container.innerHTML = "";

      const defs = [
        ["headline", "Headline", "Big title at the top of the widget card."],
        ["recordButton", "Record button text", "Main call-to-action for recording."],
        ["stopButton", "Stop button text", "Stops the recording."],
        ["uploadButton", "Upload button text", "Upload an audio file instead of recording."],
        ["previousButton", "Previous button text", "Navigate to the previous question."],
        ["nextButton", "Next button text", "Navigate to the next question."],
        [
          "SubmitForScoringButton",
          "Submit button text",
          "Final button used to send audio for scoring."
        ],
        [
          "NotRecordingLabel",
          "Recording status (idle)",
          "Status label when the widget is not recording."
        ],
        [
          "poweredByLabel",
          "Powered-by footer",
          "Brand line shown at the bottom of the card."
        ],
      ];

      defs.forEach(([key, label, help]) => {
        const field = document.createElement("div");
        field.className = "mss-field";

        const lab = document.createElement("label");
        lab.className = "mss-label";
        lab.htmlFor = key;
        lab.textContent = label;

        const input = document.createElement("input");
        input.id = key;
        input.type = "text";
        input.className = "mss-input";
        input.value = FORM[key] || "";

        input.addEventListener("input", () => {
          FORM[key] = input.value;
          renderPreview();
        });

        const small = document.createElement("div");
        small.className = "mss-muted";
        small.textContent = help;

        field.appendChild(lab);
        field.appendChild(input);
        field.appendChild(small);
        container.appendChild(field);
      });

      // survey questions
      const surveyField = document.createElement("div");
      surveyField.className = "mss-field";

      const surveyLabel = document.createElement("label");
      surveyLabel.className = "mss-label";
      surveyLabel.textContent = "Survey questions (one per line)";

      const surveyArea = document.createElement("textarea");
      surveyArea.id = "surveyText";
      surveyArea.className = "mss-textarea";
      surveyArea.rows = 6;
      surveyArea.value = (FORM.survey || []).join("\n");

      surveyArea.addEventListener("input", () => {
        const lines = surveyArea.value
          .split(/\r?\n/)
          .map((s) => s.trim())
          .filter(Boolean);
        FORM.survey = lines;
        renderPreview();
      });

      const surveyHelp = document.createElement("div");
      surveyHelp.className = "mss-muted";
      surveyHelp.textContent =
        "These lines become the questions cycled in the widget (form.survey array).";

      surveyField.appendChild(surveyLabel);
      surveyField.appendChild(surveyArea);
      surveyField.appendChild(surveyHelp);
      container.appendChild(surveyField);
    }

    /* ---------- theme binding ---------- */
    function bindTheme() {
      const sel = $("theme");
      if (!sel || !CONFIG) return;
      sel.value = CONFIG.theme || "apple";
      sel.addEventListener("change", () => {
        CONFIG.theme = sel.value;
        toast("Theme changed to " + sel.value);
      });
    }

    /* ---------- logo / branding binding ---------- */
    function bindBranding() {
      const fileInput = $("logoFile");
      const clearBtn = $("clearLogo");
      const prev = $("logoPreview");
      const nameEl = $("logoFileName");
      if (!fileInput || !clearBtn || !prev) return;

      // initial
      prev.src = IMAGES.logoDataUrl || "";
      prev.style.display = IMAGES.logoDataUrl ? "block" : "none";
      if (nameEl) {
        nameEl.textContent = IMAGES.logoDataUrl ? "Existing logo" : "No file chosen";
      }

      fileInput.addEventListener("change", () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;

        if (nameEl) {
          nameEl.textContent = file.name;
        }

        const reader = new FileReader();
        reader.onload = () => {
          IMAGES.logoDataUrl = reader.result;
          prev.src = reader.result;
          prev.style.display = "block";
          renderPreview();
          toast("Logo updated (not saved yet)");
        };
        reader.readAsDataURL(file);
      });

      clearBtn.addEventListener("click", () => {
        IMAGES.logoDataUrl = "";
        prev.src = "";
        prev.style.display = "none";
        if (nameEl) {
          nameEl.textContent = "No file chosen";
        }
        renderPreview();
        toast("Logo cleared (not saved yet)");
      });
    }

    /* ---------- logging & audio binding ---------- */
    function bindLoggingAudio() {
      const logUrlInput = $("cfgLogUrl");
      const minInput = $("cfgMinS");
      const maxInput = $("cfgMaxS");

      if (logUrlInput) {
        logUrlInput.value = (CONFIG.logger && CONFIG.logger.url) || "";
        logUrlInput.addEventListener("input", () => {
          CONFIG.logger = CONFIG.logger || {};
          CONFIG.logger.url = logUrlInput.value.trim();
        });
      }

      if (minInput) {
        minInput.value = CONFIG.audioMinSeconds ?? 30;
        minInput.addEventListener("input", () => {
          const v = Number(minInput.value) || 0;
          CONFIG.audioMinSeconds = v;
        });
      }

      if (maxInput) {
        maxInput.value = CONFIG.audioMaxSeconds ?? 61;
        maxInput.addEventListener("input", () => {
          const v = Number(maxInput.value) || 0;
          CONFIG.audioMaxSeconds = v;
        });
      }
    }

    /* ---------- preview ---------- */
    function renderPreview() {
      if (!FORM || !CONFIG || !IMAGES) return;

      const pvBrand = $("pvBrand");
      const pvLogo = $("pvLogo");
      const pvCounter = $("pvCounter");
      const pvQ = $("pvQ");
      const pvPrev = $("pvPrev");
      const pvNext = $("pvNext");
      const pvRecLabel = $("pvRecLabel");
      const pvStopLabel = $("pvStopLabel");
      const pvUploadLabel = $("pvUploadLabel");
      const pvSubmitLabel = $("pvSubmitLabel");
      const pvRecState = $("pvRecState");
      const pvPowered = $("pvPowered");

      const survey = Array.isArray(FORM.survey) ? FORM.survey : [];
      const count = survey.length || 4;

      if (pvBrand) {
        pvBrand.textContent = FORM.headline || "Practice TOEFL Speaking Test";
      }
      if (pvLogo) {
        pvLogo.src = IMAGES.logoDataUrl || "";
        pvLogo.style.display = IMAGES.logoDataUrl ? "block" : "none";
      }
      if (pvCounter) {
        pvCounter.textContent = "Question 1 of " + count;
      }
      if (pvQ) {
        pvQ.textContent =
          survey[0] ||
          "Describe a memorable teacher you have had and explain why they were memorable.";
      }

      if (pvPrev) pvPrev.textContent = FORM.previousButton || "Previous";
      if (pvNext) pvNext.textContent = FORM.nextButton || "Next";
      if (pvRecLabel) pvRecLabel.textContent = FORM.recordButton || "Record your response";
      if (pvStopLabel) pvStopLabel.textContent = FORM.stopButton || "Stop";
      if (pvUploadLabel) pvUploadLabel.textContent =
        FORM.uploadButton || "Choose an audio file";
      if (pvSubmitLabel) {
        pvSubmitLabel.textContent =
          FORM.SubmitForScoringButton || "Submit for scoring";
      }
      if (pvRecState) {
        pvRecState.textContent = FORM.NotRecordingLabel || "Not recording";
      }
      if (pvPowered) {
        pvPowered.textContent = FORM.poweredByLabel || "Powered by MSS Vox";
      }
    }

    /* ---------- network helpers ---------- */
    async function loadJson(path, fallback) {
      const base = SERVICE_BASE.replace(/\/+$/, "");
      const url = base + path;
      const res = await fetch(url, { method: "GET" });
      if (!res.ok) {
        throw new Error(res.status + " " + res.statusText);
      }
      const data = await res.json();
      return data || fallback;
    }

    async function putJson(path, body, adminKey) {
      const base = SERVICE_BASE.replace(/\/+$/, "");
      const url = base + path;
      const headers = { "Content-Type": "application/json" };
      if (adminKey) {
        headers["X-ADMIN-KEY"] = adminKey;
      }

      const res = await fetch(url, {
        method: "PUT",
        headers,
        body: JSON.stringify(body || {}),
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(
          "HTTP " +
            res.status +
            " " +
            res.statusText +
            (txt ? " – " + txt : "")
        );
      }
    }

    async function loadAll() {
      try {
        const [form, cfg, img] = await Promise.all([
          loadJson("/config/forms", {}),
          loadJson("/config/widget", {}),
          loadJson("/config/images", {}),
        ]);

        FORM = form || {};
        CONFIG = cfg || {};
        IMAGES = img || {};

        buildLabels();
        bindTheme();
        bindBranding();
        bindLoggingAudio();
        renderPreview();

        toast("Loaded config from service");
      } catch (err) {
        console.error(err);
        toast("Failed to load config: " + err.message, "err");
      }
    }

    /* ---------- saving ---------- */
    async function saveAll(adminKey) {
      if (!FORM || !CONFIG || !IMAGES) {
        throw new Error("Config not loaded yet");
      }
      await Promise.all([
        putJson("/config/forms", FORM, adminKey),
        putJson("/config/widget", CONFIG, adminKey),
        putJson("/config/images", IMAGES, adminKey),
      ]);
    }

    function handleSaveClick() {
      const adminKey = $("adminKey")?.value.trim();
      if (!adminKey) {
        showDialog(
          "Enter your admin write key first (this becomes the X-ADMIN-KEY header).",
          () => {}
        );
        return;
      }

      showDialog("Save all JSON files on the service now?", async () => {
        try {
          await saveAll(adminKey);
          toast("Saved config to Render");
        } catch (err) {
          console.error(err);
          toast("Save failed: " + err.message, "err");
        }
      });
    }

    /* ---------- wiring ---------- */
    window.addEventListener("DOMContentLoaded", () => {
      $("saveAllTop")?.addEventListener("click", handleSaveClick);
      $("saveAllBottom")?.addEventListener("click", handleSaveClick);

      $("openWidget")?.addEventListener("click", () => {
        window.open("Widget.html", "_blank");
      });

      $("openSurvey")?.addEventListener("click", () => {
        window.open("WidgetSurvey.html", "_blank");
      });

      loadAll();
    });
  </script>
</body>
</html>