<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS Score Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared MSS design system -->
  <link rel="stylesheet" href="themes/MSSStylesheet.css?v=1" />
</head>

<body class="mss-root">
  <div class="mss-shell mss-dashboard-shell">
    <section class="mss-card">
      <!-- Header: title + tag -->
      <div class="mss-dashboard-header-row">
        <div class="mss-stack-tight">
          <div class="mss-card-title">
            Speaking Score Report
          </div>
          <div id="dashQuestion" class="mss-card-subtitle">
            Latest response summary
          </div>
        </div>

        <div class="mss-dashboard-score-badge">
          <span id="dashCefr">CEFR —</span>
        </div>
      </div>

      <!-- Grid: scores + chart -->
      <div class="mss-dashboard-grid" style="margin-top: 16px;">
        <!-- LEFT: main scores -->
        <div>
          <div class="mss-dashboard-metrics">
            <div class="mss-dashboard-metric-card">
              <div class="mss-dashboard-metric-label">TOEFL (speaking est.)</div>
              <div id="scoreToefl" class="mss-dashboard-metric-value">—</div>
              <div class="mss-dashboard-metric-sub">Out of 30</div>
            </div>

            <div class="mss-dashboard-metric-card">
              <div class="mss-dashboard-metric-label">IELTS (speaking est.)</div>
              <div id="scoreIelts" class="mss-dashboard-metric-value">—</div>
              <div class="mss-dashboard-metric-sub">Band score</div>
            </div>

            <div class="mss-dashboard-metric-card">
              <div class="mss-dashboard-metric-label">PTE (speaking est.)</div>
              <div id="scorePte" class="mss-dashboard-metric-value">—</div>
              <div class="mss-dashboard-metric-sub">Out of 90</div>
            </div>

            <div class="mss-dashboard-metric-card">
              <div class="mss-dashboard-metric-label">Words per minute</div>
              <div id="scoreWpm" class="mss-dashboard-metric-value">—</div>
              <div class="mss-dashboard-metric-sub">Fluency estimate</div>
            </div>
          </div>

          <div class="mss-dashboard-transcript">
            <div class="mss-muted">
              Transcript (auto-captured)
            </div>
            <pre id="dashTranscript"></pre>
          </div>

          <div class="mss-dashboard-meta">
            <span id="dashTimestamp">Time: —</span>
            <span id="dashFile">File: —</span>
          </div>
        </div>

        <!-- RIGHT: simple bar chart -->
        <div class="mss-dashboard-chart-card">
          <div class="mss-card-title" style="font-size:0.92rem;">
            Skill profile
          </div>
          <div class="mss-card-subtitle">
            Relative strength of each estimated score
          </div>

          <div class="mss-dashboard-chart-bars" style="margin-top:10px;">
            <div class="mss-dashboard-chart-row">
              <div class="mss-dashboard-chart-label">TOEFL</div>
              <div class="mss-dashboard-chart-track">
                <div id="barToefl" class="mss-dashboard-chart-fill"></div>
              </div>
              <div id="barToeflScore" class="mss-dashboard-chart-score">—</div>
            </div>

            <div class="mss-dashboard-chart-row">
              <div class="mss-dashboard-chart-label">IELTS</div>
              <div class="mss-dashboard-chart-track">
                <div id="barIelts" class="mss-dashboard-chart-fill"></div>
              </div>
              <div id="barIeltsScore" class="mss-dashboard-chart-score">—</div>
            </div>

            <div class="mss-dashboard-chart-row">
              <div class="mss-dashboard-chart-label">PTE</div>
              <div class="mss-dashboard-chart-track">
                <div id="barPte" class="mss-dashboard-chart-fill"></div>
              </div>
              <div id="barPteScore" class="mss-dashboard-chart-score">—</div>
            </div>

            <div class="mss-dashboard-chart-row">
              <div class="mss-dashboard-chart-label">WPM</div>
              <div class="mss-dashboard-chart-track">
                <div id="barWpm" class="mss-dashboard-chart-fill"></div>
              </div>
              <div id="barWpmScore" class="mss-dashboard-chart-score">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Helper: safe access for scores (matches widget-core’s logic)
    function extractScores(raw) {
      if (!raw || typeof raw !== "object") return {};

      const elsa = raw.elsa_results || {};

      const toefl = elsa.toefl_score ?? raw.toefl_score ?? null;
      const ielts = elsa.ielts_score ?? raw.ielts_score ?? null;
      const pte   = elsa.pte_score   ?? raw.pte_score   ?? null;
      const cefr  = (elsa.cefr_level || raw.cefr_level || "").toString().toUpperCase();

      const transcript = (raw.transcript || "").toString().trim();

      return { toefl, ielts, pte, cefr, transcript };
    }

    // Helper: basic WPM estimate (same spirit as logger)
    function estimateWpm(transcript, lengthSec) {
      if (!transcript) return null;
      const words = transcript.split(/\s+/).filter(Boolean).length;
      const minutes = Math.max(0.01, (lengthSec || 0) / 60);
      return Math.round(words / minutes);
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = value;
    }

    function setBar(idFill, idScore, value, max) {
      const fill = document.getElementById(idFill);
      const score = document.getElementById(idScore);
      if (!fill || !score || value == null || isNaN(value)) {
        if (fill) fill.style.width = "0%";
        if (score) score.textContent = "—";
        return;
      }
      const pct = Math.max(0, Math.min(100, (value / max) * 100));
      fill.style.width = pct.toFixed(1) + "%";
      score.textContent = String(value);
    }

    function renderDashboard(payload) {
      if (!payload) return;

      const { toefl, ielts, pte, cefr, transcript } = extractScores(payload);

      // Meta: lengthSec, fileName, question, timestamp (if present in logger payload)
      const meta = payload._logMeta || {}; // optional, if you ever pass it along
      const lengthSec = meta.lengthSec ?? payload.lengthSec ?? 0;
      const fileName = meta.fileName || payload.fileName || "(recording)";
      const ts = meta.timestamp || payload.timestamp;

      // Scores text
      setText("scoreToefl",  toefl != null ? toefl : "—");
      setText("scoreIelts",  ielts != null ? ielts : "—");
      setText("scorePte",    pte   != null ? pte   : "—");

      const wpm = estimateWpm(transcript, lengthSec);
      setText("scoreWpm", wpm != null ? wpm : "—");

      setText("dashCefr", cefr ? ("CEFR " + cefr) : "CEFR —");

      // Question (if present)
      const question = payload.question || meta.question || "";
      if (question) {
        setText("dashQuestion", question);
      }

      // Transcript
      const transcriptEl = document.getElementById("dashTranscript");
      if (transcriptEl) {
        transcriptEl.textContent = transcript || "(No transcript returned)";
      }

      // Meta display
      setText("dashFile", "File: " + fileName);
      setText("dashTimestamp", ts ? ("Time: " + ts) : "Time: —");

      // Bars (simple normalisation)
      if (toefl != null) setBar("barToefl", "barToeflScore", toefl, 30);
      else               setBar("barToefl", "barToeflScore", null, 30);

      if (ielts != null) setBar("barIelts", "barIeltsScore", ielts, 9);
      else               setBar("barIelts", "barIeltsScore", null, 9);

      if (pte != null) setBar("barPte", "barPteScore", pte, 90);
      else             setBar("barPte", "barPteScore", null, 90);

      if (wpm != null) {
        const maxWpm = 220; // soft cap
        setBar("barWpm", "barWpmScore", wpm, maxWpm);
      } else {
        setBar("barWpm", "barWpmScore", null, 220);
      }
    }

    // Prefer live postMessage from widget; fall back to sessionStorage
    function loadInitialData() {
      try {
        const raw = sessionStorage.getItem("mss-last-results");
        if (!raw) return;
        const parsed = JSON.parse(raw);
        renderDashboard(parsed);
      } catch (e) {
        console.warn("Could not parse mss-last-results", e);
      }
    }

    window.addEventListener("message", (event) => {
      const msg = event.data;
      if (!msg || typeof msg !== "object") return;
      if (msg.type !== "mss-results") return;
      const payload = msg.payload || msg.body || msg.results || msg;
      try {
        sessionStorage.setItem("mss-last-results", JSON.stringify(payload));
      } catch (e) {
        console.warn("Unable to cache results in sessionStorage", e);
      }
      renderDashboard(payload);
    });

    window.addEventListener("DOMContentLoaded", loadInitialData);
  </script>
</body>
</html>