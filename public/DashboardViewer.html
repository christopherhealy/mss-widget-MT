<!-- /public/DashboardViewer.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS – Dashboard Viewer</title>

  <!-- Shared MSS styling (adjust paths if needed) -->
  <link rel="stylesheet" href="https://codebot.myspeakingscore.com/dynamic-widget-vue.css" />
  <link rel="stylesheet" href="/themes/MSSStylesheet.css" />

  <style>
    :root {
      --dv-bg: var(--mss-bg, #f3f4f6);
      --dv-surface: var(--mss-surface, #ffffff);
      --dv-surface-soft: var(--mss-surface-soft, #f9fafb);
      --dv-border: var(--mss-border, #e5e7eb);
      --dv-heading: var(--mss-heading, #0f172a);
      --dv-muted: var(--mss-muted, #6b7280);
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e5edff 0, #f3f4f6 45%, #e5e7eb 100%);
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Outer shell takes full viewport */
    .dv-shell {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5vh 1.5vw;
      box-sizing: border-box;
    }

    /* Main viewer dialog: 95% x 95%, rounded, Jonny-ish */
    .dv-dialog {
      width: 95vw;
      height: 95vh;
      max-width: 1280px;
      max-height: 900px; /* slightly taller than most dashboards */
      background: var(--dv-surface);
      border-radius: 24px;
      box-shadow:
        0 30px 80px rgba(15, 23, 42, 0.30),
        0 0 0 1px rgba(148, 163, 184, 0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header (top strip) */
    .dv-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.9rem 1.6rem;
      border-bottom: 1px solid var(--dv-border);
      background: linear-gradient(to bottom, #f9fafb, #ffffff);
    }

    .dv-title {
      flex: 1 1 auto;
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: var(--dv-heading);
    }

    .dv-meta {
      margin-left: 0.5rem;
      font-size: 0.8rem;
      color: var(--dv-muted);
    }

    .dv-layout-select {
      min-width: 7.5rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: 1px solid var(--dv-border);
      font-size: 0.85rem;
      background: #ffffff;
      color: var(--dv-heading);
      outline: none;
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #6b7280 50%),
        linear-gradient(135deg, #6b7280 50%, transparent 50%);
      background-position:
        calc(100% - 14px) calc(50% - 3px),
        calc(100% - 8px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    /* Main content area */
    .dv-main {
      flex: 1 1 auto;
      padding: 1rem 1.6rem;
      background: var(--dv-bg);
      display: flex;
      box-sizing: border-box;
    }

    /* Inner frame shell is just slightly inset */
    .dv-frame-shell {
      flex: 1 1 auto;
      background: var(--dv-surface-soft);
      border-radius: 18px;
      padding: 0.75rem;
      overflow: hidden;
      display: flex;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.18);
    }

    #dvFrame {
      flex: 1 1 auto;
      width: 100%;
      height: 100%;
      border: 0;
      border-radius: 14px;
      display: block;
      background: #ffffff;
      transform-origin: top left;
    }

    /* Footer */
    .dv-footer {
      padding: 0.8rem 1.6rem 1.1rem;
      border-top: 1px solid var(--dv-border);
      background: #ffffff;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .dv-btn {
      min-width: 92px;
      height: 2.25rem;
      border-radius: 999px;
      border: 1px solid var(--dv-border);
      font-size: 0.85rem;
      padding: 0 1rem;
      cursor: pointer;
      background: #ffffff;
      color: var(--dv-heading);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .dv-btn-primary {
      border-color: #1d4ed8;
      background: #1d4ed8;
      color: #ffffff;
    }

    .dv-btn:hover {
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.5);
    }

    .dv-btn-primary:hover {
      filter: brightness(1.03);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
    }

    @media (max-width: 768px) {
      .dv-dialog {
        width: 100vw;
        height: 100vh;
        max-width: none;
        max-height: none;
        border-radius: 0;
      }

      .dv-header,
      .dv-main,
      .dv-footer {
        padding-inline: 1rem;
      }

      .dv-frame-shell {
        border-radius: 12px;
        padding: 0.5rem;
      }

      #dvFrame {
        border-radius: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="dv-shell">
    <section class="dv-dialog" aria-label="Dashboard viewer">
      <header class="dv-header">
        <h1 class="dv-title">
          Dashboard view
          <span id="dvMeta" class="dv-meta"></span>
        </h1>
        <!-- No label, just the dropdown itself -->
        <select id="layoutSelect" class="dv-layout-select"></select>
      </header>

      <main class="dv-main">
        <div class="dv-frame-shell">
          <iframe
            id="dvFrame"
            title="Dashboard preview"
            src="about:blank"
          ></iframe>
        </div>
      </main>

      <footer class="dv-footer">
        <button id="dvPrintBtn" class="dv-btn">Print</button>
        <button id="dvCloseBtn" class="dv-btn dv-btn-primary">Close</button>
      </footer>
    </section>
  </div>

  <script>
    (function () {
      "use strict";

      const layoutSelect = document.getElementById("layoutSelect");
      const frame = document.getElementById("dvFrame");
      const printBtn = document.getElementById("dvPrintBtn");
      const closeBtn = document.getElementById("dvCloseBtn");
      const metaEl = document.getElementById("dvMeta");

      let DASHBOARD_LAYOUTS = [];

      function getBaseParams() {
        const params = new URLSearchParams(window.location.search);
        // "layout" is viewer-only; don't pass it through
        params.delete("layout");
        return params;
      }

      function describeMeta() {
        const params = getBaseParams();
        const slug = params.get("slug");
        const submissionId = params.get("submissionId");
        const parts = [];
        if (slug) parts.push(slug);
        if (submissionId) parts.push("submission #" + submissionId);
        metaEl.textContent = parts.length ? "• " + parts.join(" • ") : "";
      }

      function buildDashboardUrl(file) {
        const params = getBaseParams();
        const qs = params.toString();
        return "/dashboards/" + file + (qs ? "?" + qs : "");
      }

      async function loadDashboardLayouts() {
        if (DASHBOARD_LAYOUTS.length) return DASHBOARD_LAYOUTS;
        try {
          const res = await fetch("/api/admin/dashboards");
          const data = await res.json();
          DASHBOARD_LAYOUTS = (data && data.dashboards) || [];
        } catch (err) {
          console.error("Failed to load dashboard layouts:", err);
          DASHBOARD_LAYOUTS = [];
        }
        return DASHBOARD_LAYOUTS;
      }

      function pickInitialLayout(layouts) {
        const urlParams = new URLSearchParams(window.location.search);
        const fromQuery = urlParams.get("layout");

        if (fromQuery) {
          // Try match by file or label, case-insensitive
          const lower = fromQuery.toLowerCase();
          const match = layouts.find((d) =>
            (d.file && d.file.toLowerCase().includes(lower)) ||
            (d.label && d.label.toLowerCase().includes(lower))
          );
          if (match) return match.file;
        }

        // Prefer dashboard_template if present
        const template = layouts.find((d) =>
          d.file && d.file.toLowerCase().includes("dashboard_template")
        );
        if (template) return template.file;

        // Fallback: Dashboard3.html, else first
        const dash3 = layouts.find((d) =>
          d.file && d.file.toLowerCase().includes("dashboard3")
        );
        if (dash3) return dash3.file;

        return layouts[0] ? layouts[0].file : null;
      }

      function applyLayout(file) {
        if (!file) return;
        const url = buildDashboardUrl(file);
        frame.src = url;
      }

      async function init() {
        describeMeta();

        const layouts = await loadDashboardLayouts();
        layoutSelect.innerHTML = "";

        if (!layouts.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No dashboards found";
          layoutSelect.appendChild(opt);
          layoutSelect.disabled = true;
          return;
        }

        layouts.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d.file;
          opt.textContent = d.label || d.file.replace(/\.html$/i, "");
          layoutSelect.appendChild(opt);
        });

        const initialFile = pickInitialLayout(layouts);
        if (initialFile) {
          layoutSelect.value = initialFile;
          applyLayout(initialFile);
        }

        layoutSelect.addEventListener("change", () => {
          const file = layoutSelect.value;
          applyLayout(file);
        });

        printBtn.addEventListener("click", () => {
          try {
            frame.contentWindow && frame.contentWindow.print();
          } catch (err) {
            console.error("Print failed:", err);
          }
        });

        closeBtn.addEventListener("click", () => {
          // Works best when opened with window.open from the portal
          window.close();
        });
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>