<!-- Build: 2025-11-12 16:05 ET -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Speaking Score ‚Äì All-in-One Question Editor</title>
<link rel="stylesheet" href="https://codebot.myspeakingscore.com/dynamic-widget-vue.css">
<style>
  :root { --mss-blue:#1a5cff; --mss-text:#222; --mss-muted:#6b7280; --mss-edge:#e5e7eb; }
  body{ font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:#f7f7f8;margin:0;display:flex;flex-direction:column;align-items:center; min-height:100vh;padding:24px;gap:18px; }
  .card{ width:980px; max-width:95vw; background:#fff; border:1px solid var(--mss-edge); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); overflow:hidden; }
  .head{display:flex;justify-content:space-between;align-items:center; padding:14px 16px;border-bottom:1px solid var(--mss-edge)}
  .title{font-weight:700}
  .muted{color:#6b7280; font-size:12px}
  .body{padding:14px}
  .row{ display:grid; grid-template-columns:48px 1fr auto; align-items:start; gap:12px; padding:10px 12px; border:1px solid var(--mss-edge); border-radius:12px; margin-bottom:10px; background:#fff; transition:border-color .15s, box-shadow .15s, opacity .15s; }
  .row.dragging{ opacity:.7; border-color:#93c5fd; box-shadow:0 6px 20px rgba(2,132,199,.15); }
  .placeholder{ height:64px; border:2px dashed #93c5fd; border-radius:12px; background:#eff6ff; margin-bottom:10px; }
  .idx{ width:40px;height:40px;border-radius:10px;border:1px solid var(--mss-edge); display:flex;align-items:center;justify-content:center;font-weight:600;background:#f9fafb; user-select:none; cursor:grab; transition:background .15s, border-color .15s, color .15s; }
  .idx:active{ cursor:grabbing; background:#eef2ff; border-color:#c7d2fe; color:#374151; }
  .qtext{white-space:pre-line}
  .qfirst{font-weight:600}
  .ctrls{display:flex;gap:6px;flex-wrap:wrap}
  .btn{ border-radius:999px; padding:8px 10px; border:1px solid var(--mss-edge); background:#fff; cursor:pointer; font-weight:600; font-size:13px; }
  .btn.primary{background:var(--mss-blue); color:#fff; border-color:transparent}
  .btn.ghost{background:#fff}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .toolbar .spacer{flex:1}
  #status{font-size:13px;margin-left:auto}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:2100}
  .modal{width:min(700px,95vw);background:#fff;border:1px solid var(--mss-edge);border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.18);overflow:hidden}
  .modalHead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--mss-edge)}
  .modalBody{padding:12px}
  .modalFoot{display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid var(--mss-edge)}
  .ta{width:100%;min-height:200px;border:1px solid var(--mss-edge);border-radius:12px;padding:12px;font:inherit}
  .finishOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:2100}
  .finishDlg{width:min(420px,94vw);background:#fff;border:1px solid var(--mss-edge);border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.18);padding:18px}
  .finishDlg h3{margin:0 0 8px 0;font-size:16px}
  .finishDlg p{margin:0 0 12px 0;color:#374151;font-size:14px}
  .finishBtns{display:flex;gap:8px;justify-content:flex-end}
  .confirmOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:2200}
  .confirmDlg{width:min(420px,94vw);background:#fff;border:1px solid var(--mss-edge);border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.18);padding:18px}
  .confirmDlg h3{margin:0 0 8px 0;font-size:16px}
  .confirmDlg p{margin:0 0 12px 0;color:#374151;font-size:14px}
  .confirmBtns{display:flex;gap:8px;justify-content:flex-end}
  #saveToFileBtnTop, #saveToFileBtnBottom { display:none !important; }
</style>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    ['saveToFileBtnTop','saveToFileBtnBottom'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.replaceWith(el.cloneNode(true));
    });
  });
</script>
</head>
<body>
  <div class="card">
    <div class="head">
      <div>
        <div class="title">All-in-One Questions</div>
        <div class="muted">Drag with the index circle, edit in place, add/remove, import/export. Saves the <code>survey</code> order & content per <b>slug</b>.</div>
      </div>
      <div class="muted" id="meta">Loading‚Ä¶</div>
    </div>

    <div class="body">
      <div class="toolbar" style="margin-bottom:10px;">
        <button id="addBtnTop" type="button" class="btn">Ôºã Add</button>
        <div class="spacer"></div>
        <label class="btn ghost" style="display:inline-flex;align-items:center;gap:8px;">
          <input id="importJson" type="file" accept="application/json" style="display:none;"/> Import
        </label>
        <label class="btn ghost" style="display:inline-flex;align-items:center;gap:8px;">
          <input id="importCsv" type="file" accept=".csv,text/csv" style="display:none;"/> CSV Import
        </label>
        <button id="exportBtnTop" type="button" class="btn">Export</button>
        <button id="saveToFileBtnTop" type="button" class="btn">Save to file‚Ä¶</button>
        <button id="finishedBtnTop" type="button" class="btn primary">Finished‚Ä¶</button>
        <span id="status" class="muted"></span>
      </div>

      <div id="list"></div>

      <div class="toolbar" style="margin-top:10px;">
        <button id="addBtnBottom" type="button" class="btn">Ôºã Add</button>
        <div class="spacer"></div>
        <button id="exportBtnBottom" type="button" class="btn">Export</button>
        <button id="saveToFileBtnBottom" type="button" class="btn">Save to file‚Ä¶</button>
        <button id="finishedBtnBottom" type="button" class="btn primary">Finished‚Ä¶</button>
      </div>
    </div>

    <div class="footer" style="padding:12px 16px; border-top:1px solid var(--mss-edge); font-size:12px; color:#6b7280">
      Tip: <b>Export</b> downloads <code>form.json</code>.
    </div>
  </div>

  <!-- Add/Edit modal -->
  <div id="aeOverlay" class="overlay" role="dialog" aria-modal="true" hidden>
    <div class="modal">
      <div class="modalHead"><div id="aeTitle" class="title">Add Question</div></div>
      <div class="modalBody"><textarea id="aeTextarea" class="ta" placeholder="Type the question here‚Ä¶"></textarea></div>
      <div class="modalFoot">
        <button id="aeCancel" type="button" class="btn">Cancel</button>
        <button id="aeSave" type="button" class="btn">Save</button>
        <button id="aeSaveNew" type="button" class="btn">Save & New</button>
        <button id="aeClose" type="button" class="btn primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Finished dialog -->
  <div id="finishOverlay" class="finishOverlay" role="dialog" aria-modal="true" hidden>
    <div class="finishDlg">
      <h3>Do you want to save your changes before leaving?</h3>
      <p><b>Save</b> writes to the database for this <code>slug</code>, or downloads if blocked.</p>
      <div class="finishBtns">
        <button id="finishCancel" type="button" class="btn">Cancel</button>
        <button id="finishNoSave" type="button" class="btn">Don't Save</button>
        <button id="finishSave" type="button" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Confirm dialog -->
  <div id="confirmOverlay" class="confirmOverlay" role="dialog" aria-modal="true" hidden>
    <div class="confirmDlg">
      <h3 id="confirmTitle">Confirm</h3>
      <p id="confirmMsg">Are you sure?</p>
      <div class="confirmBtns">
        <button id="confirmCancel" type="button" class="btn">Cancel</button>
        <button id="confirmOk" type="button" class="btn primary">OK</button>
      </div>
    </div>
  </div>

<script>
/* ========= Build: 2025-11-12 16:05 ET ========= */

/* ------------------------------------------------------------------
   SLUG + MULTI-ENDPOINT STRATEGY
------------------------------------------------------------------ */
var params = new URLSearchParams(location.search);
var SLUG = (params.get('slug') || 'mss-demo').trim();

var HOSTS = [
  window.location.origin,
  'https://mss-widget-mt.onrender.com',
  'https://msswidget-dev.onrender.com'
];

function readCandidates(slug){
  var s = encodeURIComponent(slug);
  return [
    HOSTS[0] + '/api/admin/widget/' + s + '/form',
    HOSTS[1] + '/api/admin/widget/' + s + '/form',
    HOSTS[2] + '/api/admin/widget/' + s + '/form',
    HOSTS[0] + '/config/forms?slug=' + s,
    HOSTS[1] + '/config/forms?slug=' + s,
    HOSTS[2] + '/config/forms?slug=' + s,
    './form.json?ts=' + Date.now()
  ];
}
function writeCandidates(slug){
  var s = encodeURIComponent(slug);
  return [
    { url: HOSTS[0] + '/api/admin/widget/' + s + '/form', method: 'PUT' },
    { url: HOSTS[1] + '/api/admin/widget/' + s + '/form', method: 'PUT' },
    { url: HOSTS[2] + '/api/admin/widget/' + s + '/form', method: 'PUT' },
    { url: HOSTS[0] + '/config/forms?slug=' + s,        method: 'PUT' },
    { url: HOSTS[1] + '/config/forms?slug=' + s,        method: 'PUT' },
    { url: HOSTS[2] + '/config/forms?slug=' + s,        method: 'PUT' }
  ];
}

/* ========= state ========= */
var schema = null;
var survey = [];
var _fileHandle = null;
var aeMode = 'add';
var aeIndex = -1;
var aeDirty = false;

/* ========= helpers ========= */
function $(id){ return document.getElementById(id); }
function setStatus(msg, ok){
  if (ok === void 0) ok = true;
  var el = $('status'); if(!el) return;
  el.textContent = (ok ? '‚úÖ ' : '‚ö†Ô∏è ') + msg;
  el.style.color = ok ? 'green' : '#b45309';
  clearTimeout(setStatus._t);
  setStatus._t = setTimeout(function(){ el.textContent=''; }, 1800);
}
function escapeHtml(s){ return String(s).replace(/[&<>]/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;'})[c]; }); }
function summarize(q){
  var parts = String(q).split(/\n+/);
  var head = escapeHtml(parts[0] || '');
  var rest = escapeHtml(parts.slice(1).join('\n'));
  return '<div class="qtext"><div class="qfirst">'+head+'</div>'+ (rest ? '<div class="muted" style="margin-top:4px;white-space:pre-line">'+rest+'</div>' : '') +'</div>';
}
function getMerged(){
  var base = (schema && typeof schema === 'object') ? schema : {};
  return Object.assign({}, base, { survey: survey.slice() });
}

/* ========= render list ========= */
function move(i, d){ var j=i+d; if(j<0||j>=survey.length) return; var t=survey[i]; survey[i]=survey[j]; survey[j]=t; render(); }
function moveTo(i, dest){ dest=Math.max(0,Math.min(dest,survey.length-1)); if(i===dest) return; var it=survey.splice(i,1)[0]; survey.splice(dest,0,it); render(); }
function render(){
  var list = $('list');
  if (!survey.length){
    list.innerHTML = '<div class="muted">No questions found. Click <b>Ôºã Add</b> or use <b>Import</b>/<b>CSV Import</b>.</div>';
    return;
  }
  list.innerHTML = survey.map(function(q,i){
    return (
      '<div class="row" data-idx="'+i+'" draggable="true">'+
        '<div class="idx" title="Drag to reorder">'+(i+1)+'</div>'+
        '<div>'+summarize(q)+'</div>'+
        '<div class="ctrls">'+
          '<button type="button" class="btn" data-act="edit">Edit</button>'+
          '<button type="button" class="btn" data-act="top">Top</button>'+
          '<button type="button" class="btn" data-act="up">Up</button>'+
          '<button type="button" class="btn" data-act="down">Down</button>'+
          '<button type="button" class="btn" data-act="bottom">Bottom</button>'+
          '<button type="button" class="btn" data-act="remove">‚úï</button>'+
        '</div>'+
      '</div>'
    );
  }).join('');
  wireDnd(list);
}

/* ========= DnD ========= */
function wireDnd(container){
  var ph=null, dragging=null, src=null;
  container.querySelectorAll('.row').forEach(function(row){
    row.dataset.allow="";
    row.addEventListener('dragstart',start);
    row.addEventListener('dragend',end);
    row.querySelector('.idx').addEventListener('pointerdown',function(){ row.dataset.allow="1"; },{passive:true});
  });
  container.addEventListener('dragover',over);
  container.addEventListener('drop',drop);

  function start(e){
    var row=e.currentTarget; if(row.dataset.allow!=="1"){ e.preventDefault(); return; } row.dataset.allow="";
    dragging=row; src=+row.dataset.idx; row.classList.add('dragging');
    ph=document.createElement('div'); ph.className='placeholder'; ph.style.height=row.getBoundingClientRect().height+'px'; row.after(ph);
    e.dataTransfer.effectAllowed='move';
    try{ e.dataTransfer.setData('text/plain',String(src)); e.dataTransfer.setDragImage(row.querySelector('.idx')||row,16,16);}catch(_){}
  }
  function over(e){ if(!dragging||!ph) return; e.preventDefault(); e.dataTransfer.dropEffect='move';
    var after=getAfter(container,e.clientY); if(after==null) container.appendChild(ph); else container.insertBefore(ph,after); }
  function drop(e){ if(!dragging||!ph) return; e.preventDefault(); var target=0;
    Array.prototype.forEach.call(container.children,function(c){ if(c===ph) return; if(c.classList && c.classList.contains('row')) target++; });
    var from=src; if(from<target) target--; cleanup(); if(from==null||from===target) return;
    var m=survey.splice(from,1)[0]; survey.splice(target,0,m); render();
  }
  function end(){ cleanup(); }
  function cleanup(){ container.querySelectorAll('.row').forEach(function(r){r.dataset.allow="";}); if(dragging) dragging.classList.remove('dragging'); dragging=null; src=null; if(ph) ph.remove(); ph=null; }
  function getAfter(container,y){
    var rows=[].slice.call(container.querySelectorAll('.row:not(.dragging)'));
    return rows.reduce(function(c,ch){
      var box=ch.getBoundingClientRect(); var off=y-box.top-box.height/2;
      return (off<0&&off>c.offset)?{offset:off,element:ch}:c;
    }, {offset:-Infinity,element:null}).element;
  }
}

/* ========= Modals / confirms ========= */
function openAddModal(){ aeMode='add'; aeIndex=-1; aeDirty=false; $('aeTitle').textContent='Add Question'; $('aeTextarea').value=''; showOverlay('aeOverlay',true); }
function openEditModal(i){ aeMode='edit'; aeIndex=i; aeDirty=false; $('aeTitle').textContent='Edit Question'; $('aeTextarea').value=survey[i]||''; showOverlay('aeOverlay',true); }

function showOverlay(id,show){
  var el=$(id); if(!el) return;
  if (show) { el.hidden = false; }
  else { if (document.activeElement) document.activeElement.blur(); el.hidden = true; }
}

function wireAddEdit(){
  var ta=$('aeTextarea'); ta.addEventListener('input',function(){ aeDirty=true; });
  $('aeCancel').addEventListener('click',function(){ $('aeTextarea').value=''; aeDirty=false; showOverlay('aeOverlay',false); });
  $('aeSave').addEventListener('click',function(){ var v=ta.value.trim(); if(!v){ setStatus('Nothing to save',false); return; }
    if(aeMode==='add') survey.push(v); else if(aeMode==='edit'&&aeIndex>-1) survey[aeIndex]=v; aeDirty=false; render(); setStatus('Saved'); });
  $('aeSaveNew').addEventListener('click',function(){ var v=ta.value.trim(); if(!v){ setStatus('Nothing to save',false); return; }
    if(aeMode==='edit'&&aeIndex>-1) survey[aeIndex]=v; else survey.push(v); render(); ta.value=''; aeMode='add'; aeIndex=-1; aeDirty=false; setStatus('Saved. Ready for next.'); });
  $('aeClose').addEventListener('click', async function(){ if(aeDirty&&$('aeTextarea').value.trim()){
      var choice=await triConfirm('Save your question?','No','Cancel','Save');
      if(choice==='save'){ var v=$('aeTextarea').value.trim(); if(aeMode==='add') survey.push(v); else if(aeMode==='edit'&&aeIndex>-1) survey[aeIndex]=v; render(); aeDirty=false; showOverlay('aeOverlay',false); setStatus('Saved'); }
      else if(choice==='nosave'){ aeDirty=false; showOverlay('aeOverlay',false); }
    } else { showOverlay('aeOverlay',false); } });
}

async function confirmRemove(i){ var ok=await twoBtnConfirm('Remove this question?','Cancel','Remove'); if(!ok) return; survey.splice(i,1); render(); setStatus('Question removed'); }
function twoBtnConfirm(title,cancelLabel,okLabel){
  if(cancelLabel===void 0) cancelLabel='Cancel'; if(okLabel===void 0) okLabel='OK';
  return new Promise(function(resolve){
    var ov=$('confirmOverlay'); $('confirmTitle').textContent=title; $('confirmMsg').textContent='';
    var ok=$('confirmOk'), cancel=$('confirmCancel'); ok.textContent=okLabel; cancel.textContent=cancelLabel;
    ov.hidden=false;
    var done=function(v){ ov.hidden=true; ok.onclick=null; cancel.onclick=null; resolve(v); };
    ok.onclick=function(){ done(true); }; cancel.onclick=function(){ done(false); };
  });
}
function triConfirm(title,left,mid,right){
  if(left===void 0) left='No'; if(mid===void 0) mid='Cancel'; if(right===void 0) right='Yes';
  return new Promise(function(resolve){
    var ov=$('confirmOverlay'); $('confirmTitle').textContent=title; $('confirmMsg').textContent='';
    var ok=$('confirmOk'), cancel=$('confirmCancel'), wrap=ok.parentNode; wrap.innerHTML='';
    var L=document.createElement('button'); L.className='btn'; L.type='button'; L.textContent=left;
    var M=document.createElement('button'); M.className='btn'; M.type='button'; M.textContent=mid;
    var R=document.createElement('button'); R.className='btn primary'; R.type='button'; R.textContent=right;
    wrap.appendChild(L); wrap.appendChild(M); wrap.appendChild(R);
    ov.hidden=false;
    function cleanup(){ ov.hidden=true; wrap.innerHTML=''; wrap.appendChild(cancel); wrap.appendChild(ok); }
    L.onclick=function(){ cleanup(); resolve('nosave'); };
    M.onclick=function(){ cleanup(); resolve('cancel'); };
    R.onclick=function(){ cleanup(); resolve('save'); };
  });
}

/* ========= Save to DB (first working) with file fallback ========= */
async function saveToServer(){
  var payload = Object.assign({}, (schema||{}), { survey: survey.slice(), slug: SLUG });
  var list = writeCandidates(SLUG);
  for (var i=0;i<list.length;i++){
    var cand=list[i];
    try{
      var r = await fetch(cand.url, {
        method: cand.method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload, null, 2)
      });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      setStatus('Saved to server');
      console.log('[WidgetSurvey] saved to', cand.url);
      return 'server';
    }catch(e){
      console.warn('[WidgetSurvey] save failed @', cand.url, e);
    }
  }
  return await saveToFilePicker(payload, 'form.json'); // 'saved' | 'download' | 'canceled'
}

async function saveToFilePicker(jsonObj, suggestedName){
  if(suggestedName===void 0) suggestedName='form.json';
  var blob = new Blob([JSON.stringify(jsonObj,null,2)], {type:'application/json'});
  if(!('showSaveFilePicker' in window)){
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.setAttribute('download',suggestedName);
    document.body.appendChild(a); a.click(); document.body.removeChild(a); setTimeout(function(){URL.revokeObjectURL(a.href);},1000);
    return 'download';
  }
  try{
    if(_fileHandle){
      var perm=await _fileHandle.requestPermission({mode:'readwrite'});
      if(perm==='granted'){ var w=await _fileHandle.createWritable(); await w.write(blob); await w.close(); return 'saved'; }
    }
    _fileHandle=await window.showSaveFilePicker({ suggestedName: suggestedName, types:[{description:'JSON', accept:{'application/json':['.json']}}] });
    var w2=await _fileHandle.createWritable(); await w2.write(blob); await w2.close(); return 'saved';
  }catch(e){ console.warn('Save canceled/failed:', e); return 'canceled'; }
}

/* ========= Load (try multiple endpoints ‚Üí local fallback) ========= */
async function load(){
  var candidates = readCandidates(SLUG);
  var lastErr = null;

  for (var i=0;i<candidates.length;i++){
    var url=candidates[i];
    try{
      var r = await fetch(url, { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var raw = await r.json();
      var body = (raw && typeof raw === 'object' && (raw.form || raw)) || {};
      schema = body;
      survey = Array.isArray(body.survey) ? body.survey.slice() : [];
      $('meta').textContent = (body.headline || ('Questions for ' + SLUG)) + ' ‚Ä¢ ' + (new Date()).toLocaleString() + ' ‚Ä¢ slug=' + SLUG;
      render();
      console.log('[WidgetSurvey] loaded from', url);
      return;
    }catch(e){
      lastErr = e;
      console.warn('[WidgetSurvey] load failed @', url, e);
    }
  }

  $('meta').textContent = 'Could not load survey ‚Ä¢ slug=' + SLUG;
  setStatus('Load failed', false);
  if (lastErr) console.error(lastErr);
}

/* ========= Finished dialog ========= */
function showFinishDialog(){
  return new Promise(function(resolve){
    var ov = document.getElementById('finishOverlay');
    var save   = document.getElementById('finishSave');
    var noSave = document.getElementById('finishNoSave');
    var cancel = document.getElementById('finishCancel');

    ov.hidden = false;
    queueMicrotask(function(){ if(save) save.focus(); });

    function close(result){
      if (document.activeElement) document.activeElement.blur();
      ov.hidden = true;
      save.onclick = noSave.onclick = cancel.onclick = null;
      resolve(result);
    }

    save.onclick   = function(){ close('save'); };
    noSave.onclick = function(){ close('nosave'); };
    cancel.onclick = function(){ close('cancel'); };
  });
}

async function finishedFlow(){
  var choice = await showFinishDialog();
  if (choice === 'save'){
    var r = await saveToServer();
    if (r === 'server') setStatus('Saved to server');
    else if (r === 'saved') setStatus('Saved to file');
    else if (r === 'download') setStatus('Downloaded');
  }
}

/* ========= Row actions / boot ========= */
function wireRowActions(){
  var listEl=$('list');
  listEl.addEventListener('click',function(e){
    var btn=e.target.closest('button[data-act]'); if(!btn) return;
    var row=btn.closest('.row'); if(!row) return; var i=+row.dataset.idx;
    switch(btn.dataset.act){
      case 'edit': openEditModal(i); break;
      case 'top': moveTo(i,0); break;
      case 'up': move(i,-1); break;
      case 'down': move(i,1); break;
      case 'bottom': moveTo(i,survey.length-1); break;
      case 'remove': confirmRemove(i); break;
    }
  });
}

window.addEventListener('DOMContentLoaded', function(){
  console.log('üß© MSS Questions Admin for slug="' + SLUG + '"');
  load();
  wireRowActions();
  $('addBtnTop').addEventListener('click', openAddModal);
  $('addBtnBottom').addEventListener('click', openAddModal);
  wireAddEdit();

  $('exportBtnTop').addEventListener('click', function(){
    var a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([JSON.stringify(getMerged(),null,2)],{type:'application/json'}));
    a.setAttribute('download','form.json');
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(a.href);},1000);
    setStatus('Exported');
  });
  $('exportBtnBottom').addEventListener('click', function(){ $('exportBtnTop').click(); });

  $('finishedBtnTop').addEventListener('click', finishedFlow);
  $('finishedBtnBottom').addEventListener('click', finishedFlow);

  (function wireImportJson(){
    var f=$('importJson'); f.addEventListener('change', async function(e){
      var file=e.target.files&&e.target.files[0]; e.target.value=''; if(!file) return;
      try{
        var parsed=JSON.parse(await file.text());
        if(!parsed||typeof parsed!=='object') throw new Error('Invalid JSON object.');
        schema=parsed; survey=Array.isArray(parsed.survey)?parsed.survey.slice():[];
        setStatus('Imported JSON'); render();
        $('meta').textContent=(schema.headline||'My Speaking Score')+' ‚Ä¢ '+(new Date()).toLocaleString();
      }catch(err){ alert('Import failed: '+err.message); }
    });
  })();
  (function wireImportCsv(){
    var f=$('importCsv'); f.addEventListener('change', async function(e){
      var file=e.target.files&&e.target.files[0]; e.target.value=''; if(!file) return;
      var rows=parseCSV(await file.text()); if(!rows.length){ setStatus('CSV is empty',false); return; }
      var col=findSingleDataColumn(rows); if(col===-1){ alert('CSV must contain exactly one column with data.'); return; }
      var first=String(rows[0][col]||'').trim().toLowerCase(); var hasHeader=(first==='name'||first==='title');
      var start=hasHeader?1:0; var qs=rows.slice(start).map(function(r){return normalizeCell(r[col]);}).filter(Boolean);
      if(!qs.length){ setStatus('No questions parsed',false); return; }
      var choice=await triConfirm('Append to existing questions?','Replace','Cancel','Append'); if(choice==='cancel') return;
      if(choice==='save') survey=survey.concat(qs); else if(choice==='nosave') survey=qs.slice();
      render(); setStatus('CSV imported');
    });
  })();
});

/* ========= CSV helpers ========= */
function normalizeCell(s){ if(s==null) return ''; var t=String(s).replace(/\r\n/g,'\n').trim(); t=t.replace(/\n+/g,' // ').replace(/\s*\/\/\s*/g,' // '); return t; }
function parseCSV(text){ var rows=[]; var field='',row=[],inQ=false;
  for(var i=0;i<text.length;i++){
    var c=text[i],n=text[i+1];
    if(inQ){ if(c==='"'&&n==='"'){ field+='"'; i++; } else if(c==='"'){ inQ=false; } else { field+=c; } }
    else { if(c==='\"'){ inQ=true; } else if(c===','){ row.push(field); field=''; } else if(c==='\n'){ row.push(field); field=''; rows.push(row); row=[]; } else if(c!=='\r'){ field+=c; } }
  }
  row.push(field); rows.push(row);
  while(rows.length&&rows[rows.length-1].every(function(v){return String(v).trim()==='';})) rows.pop();
  return rows;
}
function findSingleDataColumn(rows){
  var max=0; rows.forEach(function(r){ if(r.length>max) max=r.length; });
  var idx=-1;
  for(var c=0;c<max;c++){
    var has=rows.some(function(r){ return r[c]!=null && String(r[c]).trim()!==''; });
    if(has){ if(idx!==-1) return -1; idx=c; }
  }
  return idx;
}
</script>
</body>
</html>
