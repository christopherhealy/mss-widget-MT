<!-- /public/student-portal/TaskBuilder.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task Builder</title>

  <!-- Theme -->
  <link rel="stylesheet" href="/themes/MSSStylesheet.css" />

  <style>
    /* Lightweight layout helpers (keep minimal; MSSStylesheet does most styling) */
    .tb-wrap { max-width: 1200px; margin: 28px auto; padding: 0 18px; }
    .tb-card { background: #fff; border-radius: 14px; padding: 18px; box-shadow: 0 1px 10px rgba(0,0,0,0.06); }
    .tb-h1 { font-size: 28px; margin: 0 0 6px 0; }
    .tb-sub { margin: 0 0 14px 0; opacity: 0.75; }
    .tb-grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 18px; margin-top: 14px; }
    @media (max-width: 980px) { .tb-grid { grid-template-columns: 1fr; } }

    .pill { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; background: rgba(0,0,0,0.06); }
    .tag { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; margin-right: 6px; }
    .tag.private { background: rgba(255, 165, 0, 0.12); }
    .tag.public  { background: rgba(0, 140, 255, 0.12); }
    .tag.subtle  { background: rgba(0, 0, 0, 0.06); }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 560px) { .row2 { grid-template-columns: 1fr; } }

    .field label { display: block; font-size: 12px; opacity: 0.75; margin: 8px 0 6px 0; }
    .field input, .field select, .field textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.15);
      outline: none;
    }

    .btnrow { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.18); cursor: pointer; }
    .btn.primary { background: #0b4fd6; color: #fff; border-color: transparent; }
    .btn.dark { background: #111827; color: #fff; border-color: transparent; }
    .btn.ghost { background: #fff; }
    .btn.danger { background: #b91c1c; color:#fff; border-color: transparent; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .status { font-size: 12px; margin-top: 8px; }
    .status.ok { color: #0a7a2f; }
    .status.warn { color: #a16207; }
    .status.error { color: #b91c1c; }

    .qpanel { border: 1px solid rgba(0,0,0,0.10); border-radius: 12px; padding: 12px; background: rgba(0,0,0,0.015); }
    .qlist { margin-top: 10px; border: 1px solid rgba(0,0,0,0.10); border-radius: 12px; background: #fff; overflow: hidden; }

    .qrow { display: grid; grid-template-columns: 22px 1fr; gap: 10px; padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.06); }
    .qrow:last-child { border-bottom: none; }
    .qtext { font-size: 14px; }
    .qmeta { margin-top: 6px; }

    /* Template list */
    .tlist { margin-top: 10px; border: 1px solid rgba(0,0,0,0.10); border-radius: 12px; background:#fff; overflow:hidden; }
    .trow { display:grid; grid-template-columns: 1fr auto; gap:12px; padding:12px; border-bottom:1px solid rgba(0,0,0,0.06); align-items:center; }
    .trow:last-child { border-bottom:none; }
    .trow.active { background: rgba(11,79,214,0.06); }
    .tname { font-size:14px; }
    .tmeta { margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; }
    .tactions { display:flex; gap:8px; }

    .muted { opacity: 0.7; }
    .tiny { font-size: 12px; opacity: 0.8; margin-top: 6px; }
    .divider { height:1px; background: rgba(0,0,0,0.08); margin: 12px 0; }
  </style>
</head>

<body>
  <div class="tb-wrap">
    <div class="tb-card">
      <h1 class="tb-h1">Task Builder</h1>
      <p class="tb-sub">
        Build a <strong>Task Template</strong> (widget + dashboard + questions + optional AI prompt), then generate a token URL when assigning.
      </p>

      <div class="qpanel">
        <div><strong>Signed in as:</strong> <span id="who-email">—</span></div>
        <div><strong>Role:</strong> <span id="who-role">—</span></div>
        <div style="margin-top:8px;">
          <strong>School context:</strong>
          <span class="pill" id="pill-slug">—</span>
          <span class="pill" id="pill-schoolid">id: —</span>
        </div>
        <div class="status" id="status-top"></div>
      </div>

      <div class="tb-grid">

        <!-- LEFT: Templates + Editor -->
        <div class="tb-card" style="box-shadow:none; border:1px solid rgba(0,0,0,0.08);">
          <!-- TEMPLATES LIST -->
          <h3 style="margin-top:0;">Task templates</h3>
          <div class="muted" style="font-size:13px; margin-bottom:10px;">
            Templates are reusable definitions. Select one to edit. Create a new template for a new practice task shape.
          </div>

          <div class="btnrow">
            <button class="btn primary" id="btn-new-template">New template</button>
            <button class="btn ghost" id="btn-refresh-templates">Refresh</button>
            <button class="btn dark" id="btn-back" style="margin-left:auto;">Back to Student Portal</button>
          </div>
          <div class="status" id="status-templates"></div>

          <div class="tlist" id="templates-list">
            <div style="padding:12px;" class="muted">Loading templates…</div>
          </div>

          <div class="divider"></div>

          <!-- TEMPLATE EDITOR -->
          <h3 style="margin-top:0;">Task template</h3>
          <div class="muted" style="font-size:13px; margin-bottom:10px;">
            Editing here updates the template definition (not an assignment).
          </div>

          <div class="field">
            <label for="task-title">Template title</label>
            <input id="task-title" type="text" placeholder="Recommended: short descriptive name (e.g., TOEFL L&amp;R Set 1)" />
            <div class="tiny">Used for teacher workflows and reporting.</div>
          </div>

          <div class="row2" style="margin-top:10px;">
            <div class="field">
              <label for="sel-widget">Widget</label>
              <select id="sel-widget"></select>
              <div class="tiny">Widget layout used for task-scoped links generated from this template.</div>
            </div>

            <div class="field">
              <label for="sel-dashboard">Dashboard</label>
              <select id="sel-dashboard"></select>
              <div class="tiny">Optional. Student can return to dashboard after submissions.</div>
            </div>
          </div>

          <div class="field" style="margin-top:10px;">
            <label for="sel-ai-prompt">AI prompt (optional)</label>
            <select id="sel-ai-prompt"></select>
            <div class="tiny">Attach an AI prompt so AI report generation can run automatically (or later).</div>
            <div class="status" id="status-prompts"></div>
          </div>

          <div class="btnrow">
            <button class="btn primary" id="btn-save-template">Save template</button>
            <button class="btn ghost" id="btn-duplicate-template">Duplicate</button>
            <button class="btn danger" id="btn-delete-template">Delete</button>
            <div style="margin-left:auto; align-self:center;">
              <span class="pill" id="pill-template-id">template: —</span>
            </div>
          </div>
          <div class="status" id="status-save"></div>
        </div>

        <!-- RIGHT: Questions -->
        <div class="tb-card" style="box-shadow:none; border:1px solid rgba(0,0,0,0.08);">
        <h3 style="margin-top:0;">Questions</h3>
        <div class="muted" style="font-size:13px; margin-bottom:10px;">
            Templates contain <strong>multiple questions</strong>. Students can complete one or more in a single session.
            Each submission is saved per question.
        </div>

        <!-- Visibility filter (Public / Private / All) -->
        <div class="row2">
            <div class="field">
            <label for="filter-visibility">Visibility</label>
            <select id="filter-visibility">
                <option value="private">Private</option>
                <option value="public">Public</option>
                <option value="all">All</option>
            </select>
            </div>
            <div></div>
        </div>

        <div class="btnrow" style="margin-top:10px;">
            <button class="btn dark" id="btn-clear">Clear selection</button>
            <button class="btn dark" id="btn-autoselect-3">Auto-select 3</button>
            <div style="margin-left:auto; align-self:center;">
            <span class="pill" id="pill-selected-count">Selected: 0</span>
            </div>
        </div>

        <div class="status" id="status-questions"></div>

        <div class="qlist" id="questions-list">
            <div style="padding:12px;" class="muted">Loading questions…</div>
        </div>
      </div>

      </div>
    </div>
  </div>

  <!-- Core auth/session client (needed) -->
  <script src="/js/mss_client.js?v=2026-01-28c"></script>

  <!-- IMPORTANT: cache-bust while you iterate -->
  <script src="/student-portal/TaskBuilder.js?v=2026-01-28c"></script>
</body>
</html>