<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Widget preview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Global MSS styles -->
    <link rel="stylesheet" href="/themes/MSSStylesheet.css?v=1" />
    <!-- Base widget theme; weâ€™ll swap this href based on config.theme -->
    <link
      id="mssPreviewTheme"
      rel="stylesheet"
      href="/themes/mss-widget-default.css?v=1"
    />

    <style>
      body {
        margin: 0;
        padding: 24px;
        background: #f5f7fb;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          sans-serif;
      }

      .mss-preview-shell {
        max-width: 760px;
        margin: 0 auto;
      }

      .mss-preview-header-text {
        margin-bottom: 16px;
        color: #4b5563;
        font-size: 14px;
      }

      .mss-preview-widget {
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.08);
        padding: 24px 28px 28px;
      }

      .mss-preview-top-row {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
      }

      .mss-preview-logo {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #111827;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #f9fafb;
        font-weight: 600;
        font-size: 16px;
        flex-shrink: 0;
      }

      .mss-preview-brand-headline {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
      }

      .mss-preview-powered {
        font-size: 13px;
        color: #6b7280;
      }

      .mss-preview-question {
        margin: 20px 0 16px;
        font-size: 15px;
        line-height: 1.5;
        color: #111827;
      }

      .mss-preview-controls-row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .mss-preview-btn {
        border-radius: 999px;
        border: 1px solid #d1d5db;
        padding: 7px 14px;
        font-size: 14px;
        background: #ffffff;
        cursor: default;
        color: #111827;
      }

      .mss-preview-btn-primary {
        background: #2563eb;
        border-color: #2563eb;
        color: #ffffff;
      }

      .mss-preview-btn-secondary {
        background: #f3f4f6;
      }

      .mss-preview-status {
        margin-top: 4px;
        font-size: 13px;
        color: #6b7280;
      }

      .mss-preview-upload-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #4338ca;
        font-size: 12px;
      }

      .mss-preview-footer {
        margin-top: 18px;
        font-size: 12px;
        color: #9ca3af;
      }
    </style>
  </head>
  <body>
    <div class="mss-preview-shell">
      <div class="mss-preview-header-text">
        This is a visual preview of your speaking widget using the current
        settings for this school.
      </div>

      <div class="mss-preview-widget" id="mssPreviewWidget">
        <div class="mss-preview-top-row">
          <div class="mss-preview-logo" id="mssPreviewLogoFallback">
            MSS
          </div>
          <div>
            <div
              class="mss-preview-brand-headline"
              id="mssPreviewHeadline"
            >
              CEFR Assessment
            </div>
            <div class="mss-preview-powered" id="mssPreviewPowered">
              Powered by MSS Vox
            </div>
          </div>
        </div>

        <div class="mss-preview-question" id="mssPreviewQuestion">
          Example question text will appear here.
        </div>

        <div class="mss-preview-controls-row">
          <button class="mss-preview-btn" id="mssPreviewPrev">
            Previous
          </button>
          <button class="mss-preview-btn-primary" id="mssPreviewRecord">
            Record your response
          </button>
          <button class="mss-preview-btn" id="mssPreviewStop">Stop</button>
          <button class="mss-preview-btn" id="mssPreviewNext">Next</button>
          <button class="mss-preview-btn-secondary" id="mssPreviewUpload">
            Choose an audio file
          </button>
          <button class="mss-preview-btn-primary" id="mssPreviewSubmit">
            Submit for scoring
          </button>
        </div>

        <div class="mss-preview-status" id="mssPreviewStatus">
          Not recording
        </div>

        <div
          class="mss-preview-upload-pill"
          id="mssPreviewUploadPill"
        >
          File upload allowed in this configuration
        </div>

        <div class="mss-preview-footer">
          This preview is for appearance only. Recording and scoring behaviour
          is not simulated here.
        </div>
      </div>
    </div>

    <script>
      (async function () {
        const params = new URLSearchParams(window.location.search);
        const slug = (params.get("slug") || "mss-demo").trim();

        const headlineEl = document.getElementById("mssPreviewHeadline");
        const poweredEl = document.getElementById("mssPreviewPowered");
        const questionEl = document.getElementById("mssPreviewQuestion");
        const statusEl = document.getElementById("mssPreviewStatus");

        const prevBtn = document.getElementById("mssPreviewPrev");
        const nextBtn = document.getElementById("mssPreviewNext");
        const recBtn = document.getElementById("mssPreviewRecord");
        const stopBtn = document.getElementById("mssPreviewStop");
        const uploadBtn = document.getElementById("mssPreviewUpload");
        const submitBtn = document.getElementById("mssPreviewSubmit");
        const uploadPill = document.getElementById(
          "mssPreviewUploadPill"
        );

        const themeLink = document.getElementById("mssPreviewTheme");

        try {
          const res = await fetch(
            "/api/widget/" + encodeURIComponent(slug) + "/bootstrap",
            { headers: { Accept: "application/json" } }
          );
          if (!res.ok) {
            throw new Error("Bootstrap failed: " + res.status);
          }
          const data = await res.json();

          const config = data.config || {};
          const form = data.form || {};
          const questions =
            Array.isArray(form.survey) && form.survey.length
              ? form.survey
              : [
                  "This is an example question. Your real questions are configured on the Questions tab.",
                ];

          // ---- theme map -> CSS file ----
          const theme = config.theme || "default";
          if (themeLink) {
            let href = "/themes/mss-widget-default.css?v=1";
            if (theme === "apple") {
              href = "/themes/mss-widget-apple.css?v=1";
            } else if (theme === "pink") {
              href = "/themes/mss-widget-pink.css?v=1";
            } else if (theme === "master") {
              href = "/themes/mss-widget-master.css?v=1";
            }
            themeLink.href = href;
          }

          // ---- text labels ----
          if (headlineEl)
            headlineEl.textContent =
              form.headline || "CEFR Assessment";

          if (poweredEl)
            poweredEl.textContent =
              form.poweredByLabel || "Powered by MSS Vox";

          if (questionEl) questionEl.textContent = questions[0];

          if (statusEl)
            statusEl.textContent =
              form.NotRecordingLabel || "Not recording";

          if (recBtn)
            recBtn.textContent =
              form.recordButton || "Record your response";
          if (prevBtn)
            prevBtn.textContent =
              form.previousButton || "Previous";
          if (nextBtn)
            nextBtn.textContent = form.nextButton || "Next";
          if (stopBtn)
            stopBtn.textContent = form.stopButton || "Stop";
          if (uploadBtn)
            uploadBtn.textContent =
              form.uploadButton || "Choose an audio file";
          if (submitBtn)
            submitBtn.textContent =
              form.SubmitForScoringButton || "Submit for scoring";

          // ---- visibility based on config.show + Permitupload ----
          const show = config.show || {};

          if (prevBtn)
            prevBtn.style.display =
              show.prevButton === false ? "none" : "inline-block";
          if (nextBtn)
            nextBtn.style.display =
              show.nextButton === false ? "none" : "inline-block";
          if (recBtn)
            recBtn.style.display =
              show.recordButton === false ? "none" : "inline-block";
          if (stopBtn)
            stopBtn.style.display =
              show.stopButton === false ? "none" : "inline-block";
          if (submitBtn)
            submitBtn.style.display =
              show.submitButton === false ? "none" : "inline-block";
          if (statusEl)
            statusEl.style.display =
              show.notRecordingLabel === false
                ? "none"
                : "block";

          // Permitupload flag (default true)
          const permitUpload =
            typeof config.Permitupload === "boolean"
              ? config.Permitupload
              : true;

          if (uploadBtn)
            uploadBtn.style.display = permitUpload
              ? "inline-block"
              : "none";
          if (uploadPill)
            uploadPill.style.display = permitUpload ? "inline-flex" : "none";
        } catch (err) {
          console.error("[preview] error:", err);
          if (statusEl) {
            statusEl.textContent =
              "Preview failed to load configuration.";
          }
        }
      })();
    </script>
  </body>
</html>