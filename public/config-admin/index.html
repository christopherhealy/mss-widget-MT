<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS Widget – Configuration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Main MSS theme -->
  <link rel="stylesheet" href="/themes/MSSStylesheet.css?v=1" />
  <!-- Config-admin specific styles -->
  <link rel="stylesheet" href="/themes/mss-config-admin.css?v=1" />
</head>
<body class="mss-config-body">
  <div class="mss-config-shell">
    <!-- Header + nav -->
    <header class="mss-config-header">
      <div class="mss-config-brand">
        <div class="mss-config-mark">MSS</div>
        <div>
          <div class="mss-config-brand-main">MSS Widget</div>
          <div class="mss-config-brand-sub" id="configSchoolLabel">
            Widget configuration
          </div>
        </div>
      </div>

      <nav class="mss-config-nav">
        <a id="navConfig" href="#" class="mss-config-nav-link active">
          Configuration
        </a>
        <a id="navQuestions" href="#" class="mss-config-nav-link">
          Questions
        </a>
        <a id="navReports" href="#" class="mss-config-nav-link">
          Reports
        </a>
      </nav>
    </header>

    <main class="mss-config-main">
      <!-- Left column: forms -->
      <section class="mss-config-columns">
        <div class="mss-config-left">

          <!-- Widget behaviour -->
          <section class="mss-config-card">
            <h2 class="mss-config-card-title">Widget behaviour</h2>
            <p class="mss-config-card-sub">
              Control which parts of the widget are visible to students.
            </p>

            <div class="mss-config-grid mss-config-grid-2">
              <label class="mss-config-check">
                <input type="checkbox" id="editable-headline" />
                <span>Show headline</span>
              </label>

              <label class="mss-config-check">
                <input type="checkbox" id="editable-recordButton" />
                <span>Show “Record” button</span>
              </label>

              <label class="mss-config-check">
                <input type="checkbox" id="editable-previousButton" />
                <span>Show “Previous” button</span>
              </label>

              <label class="mss-config-check">
                <input type="checkbox" id="editable-nextButton" />
                <span>Show “Next” button</span>
              </label>

              <label class="mss-config-check">
                <input type="checkbox" id="editable-stopButton" />
                <span>Show “Stop” button</span>
              </label>

              <label class="mss-config-check">
                <input type="checkbox" id="editable-uploadButton" />
                <span>Show upload button</span>
              </label>

              <label class="mss-config-check">
                <input type="checkbox" id="editable-poweredByLabel" />
                <span>Show “Powered by” label</span>
              </label>

              <label class="mss-config-check">
                <input type="checkbox" id="editable-NotRecordingLabel" />
                <span>Show “Not recording” label</span>
              </label>

              <label class="mss-config-check">
                <input type="checkbox" id="editable-SubmitForScoringButton" />
                <span>Show “Submit for scoring” button</span>
              </label>
            </div>

            <div class="mss-config-divider"></div>

            <label class="mss-config-check">
              <input type="checkbox" id="config-Permitupload" />
              <span>Allow file upload (instead of record-only)</span>
            </label>
          </section>

          <!-- Theme + recording limits -->
          <section class="mss-config-card">
            <h2 class="mss-config-card-title">Theme & limits</h2>
            <p class="mss-config-card-sub">
              Choose your visual theme and recording length constraints.
            </p>

            <div class="mss-config-field">
              <label for="config-theme">Theme</label>
              <select id="config-theme">
                <option value="apple">Apple (light)</option>
                <option value="mss">MSS Standard</option>
                <option value="dark">Dark</option>
              </select>
            </div>

            <div class="mss-config-grid mss-config-grid-2">
              <div class="mss-config-field">
                <label for="config-minSeconds">Minimum length (seconds)</label>
                <input
                  id="config-minSeconds"
                  type="number"
                  min="5"
                  step="1"
                  placeholder="20"
                />
              </div>

              <div class="mss-config-field">
                <label for="config-maxSeconds">Maximum length (seconds)</label>
                <input
                  id="config-maxSeconds"
                  type="number"
                  min="10"
                  step="1"
                  placeholder="100"
                />
              </div>
            </div>
          </section>

          <!-- API + logger -->
          <section class="mss-config-card">
            <h2 class="mss-config-card-title">API & logging</h2>
            <p class="mss-config-card-sub">
              MSS API credentials and where to log submissions.
            </p>

            <div class="mss-config-field">
              <label for="config-api-base">MSS API base URL</label>
              <input
                id="config-api-base"
                type="url"
                placeholder="https://app.myspeakingscore.com"
              />
            </div>

            <div class="mss-config-grid mss-config-grid-2">
              <div class="mss-config-field">
                <label for="config-api-key">API key</label>
                <input
                  id="config-api-key"
                  type="text"
                  autocomplete="off"
                />
              </div>
              <div class="mss-config-field">
                <label for="config-api-secret">API secret</label>
                <input
                  id="config-api-secret"
                  type="password"
                  autocomplete="off"
                />
              </div>
            </div>

            <div class="mss-config-divider"></div>

            <label class="mss-config-check">
              <input type="checkbox" id="config-logger-enabled" />
              <span>Enable logging</span>
            </label>

            <div class="mss-config-field">
              <label for="config-logger-url">Logger URL</label>
              <input
                id="config-logger-url"
                type="url"
                placeholder="(leave blank for default MSS logger)"
              />
            </div>
          </section>

          <!-- Save -->
          <section class="mss-config-actions">
            <button id="config-saveBtn" class="mss-config-saveBtn">
              Save configuration
            </button>
            <p id="config-saveStatus" class="mss-config-status"></p>
          </section>
        </div>

        <!-- Right column: live-ish preview -->
        <aside class="mss-config-right">
          <section class="mss-config-card mss-config-preview-card">
            <h2 class="mss-config-card-title">Widget preview</h2>
            <p class="mss-config-card-sub">
              This is how your students see the widget for this school.
            </p>

            <div class="mss-config-preview-frame-wrap">
              <iframe
                id="config-previewFrame"
                src=""
                class="mss-config-preview-frame"
                title="Widget preview"
              ></iframe>
            </div>

            <p class="mss-config-hint">
              If changes don’t appear immediately, click “Save configuration”
              and refresh this page or the student page.
            </p>
          </section>
        </aside>
      </section>
    </main>
  </div>

  <script>
    (function () {
      // --- helpers ---
      function qs(id) {
        return document.getElementById(id);
      }

      function getSlug() {
        const params = new URLSearchParams(window.location.search);
        return params.get("slug") || "mss-demo";
      }

      let currentSlug = null;
      let currentConfig = null;
      let currentForm = null;
      let currentBilling = null;

      function wireNav(slug) {
        const baseConfig = "/config-admin/";
        const baseQuestions = "/questions-admin/";
        const baseReports = "/reports/";

        const navConfig = qs("navConfig");
        const navQuestions = qs("navQuestions");
        const navReports = qs("navReports");

        if (navConfig) {
          navConfig.href = baseConfig + "?slug=" + encodeURIComponent(slug);
        }
        if (navQuestions) {
          navQuestions.href =
            baseQuestions + "?slug=" + encodeURIComponent(slug);
        }
        if (navReports) {
          navReports.href =
            baseReports + "?slug=" + encodeURIComponent(slug);
        }
      }

      function setStatus(msg, ok = true) {
        const el = qs("config-saveStatus");
        if (!el) return;
        el.textContent = msg || "";
        el.className =
          "mss-config-status " + (msg ? (ok ? "ok" : "err") : "");
      }

      function fillConfigUI(resp) {
        const schoolId = resp.schoolId;
        const slug = resp.slug;
        const cfg = resp.config || {};
        const editable = cfg.editable || {};
        const billing = resp.billing || {};
        const form = resp.form || {};

        currentSlug = slug;
        currentConfig = cfg;
        currentForm = form;
        currentBilling = billing;

        const labelEl = qs("configSchoolLabel");
        if (labelEl) {
          labelEl.textContent =
            "Widget configuration – " + (form.headline || slug);
        }

        // Editable toggles
        const map = [
          ["editable-headline", "headline"],
          ["editable-recordButton", "recordButton"],
          ["editable-previousButton", "previousButton"],
          ["editable-nextButton", "nextButton"],
          ["editable-stopButton", "stopButton"],
          ["editable-uploadButton", "uploadButton"],
          ["editable-poweredByLabel", "poweredByLabel"],
          ["editable-NotRecordingLabel", "NotRecordingLabel"],
          [
            "editable-SubmitForScoringButton",
            "SubmitForScoringButton"
          ],
        ];

        map.forEach(([id, key]) => {
          const cb = qs(id);
          if (cb) cb.checked = editable[key] !== false;
        });

        const permitCb = qs("config-Permitupload");
        if (permitCb) {
          permitCb.checked = cfg.Permitupload !== false;
        }

        const themeSel = qs("config-theme");
        if (themeSel) {
          const theme = cfg.theme || "apple";
          if ([...themeSel.options].some((o) => o.value === theme)) {
            themeSel.value = theme;
          } else {
            themeSel.value = "apple";
          }
        }

        const minI = qs("config-minSeconds");
        const maxI = qs("config-maxSeconds");
        if (minI) minI.value = cfg.audioMinSeconds ?? 20;
        if (maxI) maxI.value = cfg.audioMaxSeconds ?? 100;

        const api = cfg.api || {};
        const logger = cfg.logger || {};

        const apiBase = qs("config-api-base");
        const apiKey = qs("config-api-key");
        const apiSecret = qs("config-api-secret");
        const loggerEnabled = qs("config-logger-enabled");
        const loggerUrl = qs("config-logger-url");

        if (apiBase) apiBase.value = api.baseUrl || "";
        if (apiKey) apiKey.value = api.key || "";
        if (apiSecret) apiSecret.value = api.secret || "";
        if (loggerEnabled) loggerEnabled.checked = !!logger.enabled;
        if (loggerUrl) loggerUrl.value = logger.url || "";

        // Preview iframe
        const frame = qs("config-previewFrame");
        if (frame) {
          const base = window.location.origin.replace(/\/+$/, "");
          frame.src =
            base +
            "/Widget.html?slug=" +
            encodeURIComponent(slug);
        }
      }

      async function loadConfig() {
        const slug = getSlug();
        wireNav(slug);
        setStatus("Loading configuration…", true);

        try {
          const res = await fetch(
            "/api/admin/widget/" + encodeURIComponent(slug)
          );
          const body = await res.json().catch(() => ({}));

          if (!res.ok || !body.ok) {
            const msg =
              body.message ||
              body.error ||
              "Failed to load widget configuration.";
            setStatus(msg, false);
            return;
          }

          fillConfigUI(body);
          setStatus("");
        } catch (err) {
          console.error("loadConfig error:", err);
          setStatus("Network error while loading configuration.", false);
        }
      }

      function buildConfigFromUI() {
        const cfg = currentConfig || {};
        const editable = cfg.editable || {};

        function isChecked(id, defaultVal = true) {
          const cb = qs(id);
          if (!cb) return defaultVal;
          return !!cb.checked;
        }

        const newEditable = {
          headline: isChecked("editable-headline"),
          recordButton: isChecked("editable-recordButton"),
          previousButton: isChecked("editable-previousButton"),
          nextButton: isChecked("editable-nextButton"),
          stopButton: isChecked("editable-stopButton"),
          uploadButton: isChecked("editable-uploadButton"),
          poweredByLabel: isChecked("editable-poweredByLabel"),
          NotRecordingLabel: isChecked("editable-NotRecordingLabel"),
          SubmitForScoringButton: isChecked(
            "editable-SubmitForScoringButton"
          ),
        };

        const permitCb = qs("config-Permitupload");
        const themeSel = qs("config-theme");
        const minI = qs("config-minSeconds");
        const maxI = qs("config-maxSeconds");
        const apiBase = qs("config-api-base");
        const apiKey = qs("config-api-key");
        const apiSecret = qs("config-api-secret");
        const loggerEnabled = qs("config-logger-enabled");
        const loggerUrl = qs("config-logger-url");

        const minSeconds = Number(minI && minI.value) || 20;
        const maxSeconds = Number(maxI && maxI.value) || 100;

        const apiBaseUrl = apiBase ? apiBase.value.trim() : "";
        const apiKeyVal = apiKey ? apiKey.value.trim() : "";
        const apiSecretVal = apiSecret ? apiSecret.value.trim() : "";

        const apiEnabled =
          !!apiBaseUrl && !!apiKeyVal && !!apiSecretVal;

        return {
          ...cfg,
          editable: newEditable,
          Permitupload: permitCb ? !!permitCb.checked : true,
          theme: themeSel ? themeSel.value : cfg.theme || "apple",
          audioMinSeconds: minSeconds,
          audioMaxSeconds: maxSeconds,
          api: {
            enabled: apiEnabled,
            baseUrl: apiBaseUrl,
            key: apiKeyVal,
            secret: apiSecretVal,
          },
          logger: {
            enabled: loggerEnabled ? !!loggerEnabled.checked : false,
            url: loggerUrl ? loggerUrl.value.trim() : "",
          },
        };
      }

      async function saveConfig() {
        if (!currentSlug) {
          setStatus("No school loaded yet.", false);
          return;
        }

        const btn = qs("config-saveBtn");
        if (btn) btn.disabled = true;
        setStatus("Saving…", true);

        const newConfig = buildConfigFromUI();

        const payload = {
          config: newConfig,
          // preserve current form & billing so we don’t wipe them
          form: currentForm || {},
          billing: currentBilling || {},
        };

        try {
          const res = await fetch(
            "/api/admin/widget/" + encodeURIComponent(currentSlug),
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );
          const body = await res.json().catch(() => ({}));

          if (!res.ok || !body.ok) {
            const msg =
              body.message ||
              body.error ||
              "Failed to save configuration.";
            setStatus(msg, false);
            return;
          }

          currentConfig = newConfig;
          setStatus("Configuration saved.", true);
        } catch (err) {
          console.error("saveConfig error:", err);
          setStatus("Network error while saving configuration.", false);
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        const saveBtn = qs("config-saveBtn");
        if (saveBtn) {
          saveBtn.addEventListener("click", (e) => {
            e.preventDefault();
            saveConfig();
          });
        }
        loadConfig();
      });
    })();
  </script>
</body>
</html>