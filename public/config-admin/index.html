<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS Widget – Configuration</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/themes/MSSStylesheet.css?v=1" />
  <link rel="stylesheet" href="/themes/mss-config-admin.css?v=1" />
  <style>
    /* Small helpers so chevrons + collapse work even if CSS file lags */
    .mss-admin-card-body[hidden]{ display:none; }
    .mss-admin-toggle { display:inline-flex; gap:6px; align-items:center; }
    .mss-admin-toggle .chev { transition: transform .15s ease; }
    .mss-admin-toggle[aria-expanded="true"] .chev { transform: rotate(90deg); }
  </style>
</head>
<body class="mss-admin-body">
  <div class="mss-admin-shell" data-app="config-admin">
    <!-- Header -->
    <header class="mss-admin-header">
      <div class="mss-admin-brand">
        <div class="mss-admin-mark">MSS</div>
        <div class="mss-admin-brand-text">
          <div class="mss-admin-brand-main">MSS Widget Admin</div>
          <div class="mss-admin-brand-sub">Configure your school’s speaking widget</div>
        </div>
      </div>
      <div class="mss-admin-school">
        School: <span id="mssAdminSchoolSlug" class="mss-admin-school-slug">(loading…)</span>
      </div>
    </header>

    <!-- Tabs: Configuration (static), Questions, Reports -->
    <nav class="mss-admin-tabs">
      <div class="mss-admin-tab mss-admin-tab--static is-active">Configuration</div>
      <button id="mssAdminBtnQuestions" type="button" class="mss-admin-tab">Questions</button>
      <button id="mssAdminBtnReports" type="button" class="mss-admin-tab mss-admin-tab--disabled">Reports</button>
    </nav>

    <main class="mss-admin-main">
      <section class="mss-admin-column mss-admin-column-left">
        <form id="mssConfigForm" class="mss-admin-form">
          <h1 class="mss-admin-page-title">Widget configuration</h1>
          <p class="mss-admin-intro">
            Control how your widget looks and behaves. Edit question text and order on the <strong>Questions</strong> page.
          </p>

          <!-- Brand & text -->
          <section class="mss-admin-card" data-section="brand">
            <div class="mss-admin-card-header">
              <h2 class="mss-admin-section-title">Brand &amp; text</h2>
              <button type="button" class="mss-admin-toggle" aria-expanded="false">
                <span class="chev">▸</span><span>Expand</span>
              </button>
            </div>
            <div class="mss-admin-card-body" hidden>
              <label class="mss-admin-field">
                <span class="mss-admin-label">Headline</span>
                <input id="cfgHeadline" type="text" class="mss-admin-input" placeholder="CEFR Assessment"/>
              </label>
              <label class="mss-admin-field">
                <span class="mss-admin-label">Powered by label</span>
                <input id="cfgPoweredBy" type="text" class="mss-admin-input" placeholder="Powered by MSS Vox"/>
              </label>
              <label class="mss-admin-checkbox">
                <input id="cfgEditableHeadline" type="checkbox" class="mss-admin-checkbox-input"/>
                <span>Allow headline editing in future (keep flexible)</span>
              </label>
            </div>
          </section>

          <!-- Theme, timing, upload -->
          <section class="mss-admin-card" data-section="theme">
            <div class="mss-admin-card-header">
              <h2 class="mss-admin-section-title">Theme, timing &amp; upload</h2>
              <button type="button" class="mss-admin-toggle" aria-expanded="false">
                <span class="chev">▸</span><span>Expand</span>
              </button>
            </div>
            <div class="mss-admin-card-body" hidden>
              <div class="mss-admin-grid mss-admin-grid-2">
                <label class="mss-admin-field">
                  <span class="mss-admin-label">Theme</span>
                  <select id="cfgTheme" class="mss-admin-input">
                    <option value="default">Default</option>
                    <option value="apple">Apple</option>
                    <option value="pink">Pink</option>
                    <option value="master">Master</option>
                  </select>
                </label>
                <label class="mss-admin-checkbox mss-admin-field">
                  <input id="cfgAllowUpload" type="checkbox" class="mss-admin-checkbox-input"/>
                  <span>Allow students to upload audio files</span>
                </label>
              </div>
              <div class="mss-admin-grid mss-admin-grid-2">
                <label class="mss-admin-field">
                  <span class="mss-admin-label">Minimum length (seconds)</span>
                  <input id="cfgMinSec" type="number" min="0" class="mss-admin-input" placeholder="30"/>
                </label>
                <label class="mss-admin-field">
                  <span class="mss-admin-label">Maximum length (seconds)</span>
                  <input id="cfgMaxSec" type="number" min="0" class="mss-admin-input" placeholder="61"/>
                </label>
              </div>
              <p class="mss-admin-help">These limits are enforced when students submit audio for scoring.</p>
            </div>
          </section>

          <!-- Buttons & labels -->
          <section class="mss-admin-card" data-section="buttons">
            <div class="mss-admin-card-header">
              <h2 class="mss-admin-section-title">Buttons &amp; labels</h2>
              <button type="button" class="mss-admin-toggle" aria-expanded="false">
                <span class="chev">▸</span><span>Expand</span>
              </button>
            </div>
            <div class="mss-admin-card-body" hidden>
              <p class="mss-admin-help">Choose visibility and labels shown in the widget.</p>

              <div class="mss-admin-subsection">
                <h3 class="mss-admin-subtitle">Visibility</h3>
                <div class="mss-admin-checkbox-grid">
                  <label class="mss-admin-checkbox"><input id="showHeadline" type="checkbox" class="mss-admin-checkbox-input"/><span>Show headline</span></label>
                  <label class="mss-admin-checkbox"><input id="showRecordButton" type="checkbox" class="mss-admin-checkbox-input"/><span>Show “Record” button</span></label>
                  <label class="mss-admin-checkbox"><input id="showPrevButton" type="checkbox" class="mss-admin-checkbox-input"/><span>Show “Previous” button</span></label>
                  <label class="mss-admin-checkbox"><input id="showNextButton" type="checkbox" class="mss-admin-checkbox-input"/><span>Show “Next” button</span></label>
                  <label class="mss-admin-checkbox"><input id="showStopButton" type="checkbox" class="mss-admin-checkbox-input"/><span>Show “Stop” button</span></label>
                  <label class="mss-admin-checkbox"><input id="showUploadButton" type="checkbox" class="mss-admin-checkbox-input"/><span>Show upload button</span></label>
                  <label class="mss-admin-checkbox"><input id="showPoweredByLabel" type="checkbox" class="mss-admin-checkbox-input"/><span>Show “Powered by” label</span></label>
                  <label class="mss-admin-checkbox"><input id="showNotRecordingLabel" type="checkbox" class="mss-admin-checkbox-input"/><span>Show “Not recording” label</span></label>
                  <label class="mss-admin-checkbox"><input id="showSubmitButton" type="checkbox" class="mss-admin-checkbox-input"/><span>Show “Submit for scoring” button</span></label>
                </div>
              </div>

              <div class="mss-admin-subsection">
                <h3 class="mss-admin-subtitle">Text labels</h3>
                <div class="mss-admin-grid mss-admin-grid-2">
                  <label class="mss-admin-field"><span class="mss-admin-label">Record</span><input id="labelRecord" type="text" class="mss-admin-input" placeholder="Record your response"/></label>
                  <label class="mss-admin-field"><span class="mss-admin-label">Previous</span><input id="labelPrev" type="text" class="mss-admin-input" placeholder="Previous"/></label>
                  <label class="mss-admin-field"><span class="mss-admin-label">Next</span><input id="labelNext" type="text" class="mss-admin-input" placeholder="Next"/></label>
                  <label class="mss-admin-field"><span class="mss-admin-label">Stop</span><input id="labelStop" type="text" class="mss-admin-input" placeholder="Stop"/></label>
                  <label class="mss-admin-field"><span class="mss-admin-label">Upload</span><input id="labelUpload" type="text" class="mss-admin-input" placeholder="Choose an audio file"/></label>
                  <label class="mss-admin-field"><span class="mss-admin-label">Submit</span><input id="labelSubmit" type="text" class="mss-admin-input" placeholder="Submit for scoring"/></label>
                  <label class="mss-admin-field"><span class="mss-admin-label">Not recording</span><input id="labelNotRecording" type="text" class="mss-admin-input" placeholder="Not recording"/></label>
                </div>
              </div>
            </div>
          </section>

          <!-- API & logging -->
          <section class="mss-admin-card" data-section="api">
            <div class="mss-admin-card-header">
              <h2 class="mss-admin-section-title">MSS API &amp; logging</h2>
              <button type="button" class="mss-admin-toggle" aria-expanded="false">
                <span class="chev">▸</span><span>Expand</span>
              </button>
            </div>
            <div class="mss-admin-card-body" hidden>
              <label class="mss-admin-field"><span class="mss-admin-label">MSS API base URL</span><input id="cfgApiBaseUrl" type="text" class="mss-admin-input" placeholder="https://app.myspeakingscore.com"/></label>
              <label class="mss-admin-field"><span class="mss-admin-label">API key</span><input id="cfgApiKey" type="text" class="mss-admin-input" autocomplete="off"/></label>
              <label class="mss-admin-field"><span class="mss-admin-label">API secret</span><input id="cfgApiSecret" type="password" class="mss-admin-input" autocomplete="off"/></label>
              <div class="mss-admin-subsection">
                <h3 class="mss-admin-subtitle">Submission logging</h3>
                <label class="mss-admin-checkbox"><input id="cfgLoggerEnabled" type="checkbox" class="mss-admin-checkbox-input"/><span>Log submissions to an external endpoint</span></label>
                <label class="mss-admin-field"><span class="mss-admin-label">Logger URL</span><input id="cfgLoggerUrl" type="text" class="mss-admin-input" placeholder="https://example.com/log-endpoint"/></label>
              </div>
            </div>
          </section>

          <!-- Usage & safety -->
          <section class="mss-admin-card" data-section="usage">
            <div class="mss-admin-card-header">
              <h2 class="mss-admin-section-title">Usage &amp; safety limits</h2>
              <button type="button" class="mss-admin-toggle" aria-expanded="false">
                <span class="chev">▸</span><span>Expand</span>
              </button>
            </div>
            <div class="mss-admin-card-body" hidden>
              <label class="mss-admin-field">
                <span class="mss-admin-label">Daily limit</span>
                <input id="cfgDailyLimit" type="number" min="0" class="mss-admin-input" placeholder="50"/>
                <span class="mss-admin-help">0 = no limit (not recommended in production).</span>
              </label>
              <label class="mss-admin-checkbox"><input id="cfgNotifyOnLimit" type="checkbox" class="mss-admin-checkbox-input"/><span>Email the admin when the daily limit is reached</span></label>
              <label class="mss-admin-checkbox"><input id="cfgAutoBlockOnLimit" type="checkbox" class="mss-admin-checkbox-input"/><span>Hide the widget automatically when the limit is reached</span></label>
            </div>
          </section>

          <!-- Branding -->
          <section class="mss-admin-card" data-section="branding">
            <div class="mss-admin-card-header">
              <h2 class="mss-admin-section-title">Branding</h2>
              <button type="button" class="mss-admin-toggle" aria-expanded="false">
                <span class="chev">▸</span><span>Expand</span>
              </button>
            </div>
            <div class="mss-admin-card-body" hidden>
              <div class="mss-branding-row">
                <div class="mss-branding-preview">
                  <img id="mssBrandLogoImg" alt="Current logo preview" class="mss-branding-logo" style="display:none;" />
                  <div id="mssBrandLogoStatus" class="mss-admin-help">No logo uploaded yet.</div>
                </div>
                <div class="mss-branding-controls">
                  <label class="mss-admin-field">
                    <span class="mss-admin-label">Upload logo (PNG or JPG)</span>
                    <input id="mssBrandLogoFile" type="file" accept="image/*" class="mss-admin-input" />
                  </label>
                  <p class="mss-admin-help">Recommended: square ≥ 200×200 px. Used in the widget header.</p>
                </div>
              </div>
            </div>
          </section>

          <!-- Footer -->
          <div class="mss-admin-footer">
            <p id="mssAdminStatus" class="mss-admin-status"></p>
            <div class="mss-admin-footer-actions">
              <button type="button" id="mssOpenWidget" class="mss-admin-secondary-btn">Open widget</button>
              <button type="submit" class="mss-admin-primary-btn">Save changes</button>
            </div>
          </div>
        </form>
      </section>
    </main>
  </div>

  <script src="/config-admin/config-admin.js?v=2"></script>
  <script>
    // Minimal inline wiring so UX is correct even before JS bundle updates.
    (function () {
      const qs = (s, r = document) => r.querySelector(s);
      const qsa = (s, r = document) => Array.from(r.querySelectorAll(s));

      // Chevron/collapse: default collapsed
      qsa('.mss-admin-card').forEach(card => {
        const btn = qs('.mss-admin-toggle', card);
        const body = qs('.mss-admin-card-body', card);
        if (!btn || !body) return;
        // ensure collapsed by default
        btn.setAttribute('aria-expanded', 'false');
        body.hidden = true;
        btn.addEventListener('click', () => {
          const open = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', String(!open));
          body.hidden = open;
          btn.lastElementChild.textContent = open ? 'Expand' : 'Collapse';
        });
      });

      // Buttons → real pages
      const slugEl = document.getElementById('mssAdminSchoolSlug');
      const getSlug = () => (slugEl?.dataset.slug || slugEl?.textContent || '').trim();

      document.getElementById('mssAdminBtnQuestions')?.addEventListener('click', () => {
        const slug = getSlug();
        if (!slug) return alert('School slug not ready yet.');
        location.href = `/questions-admin/WidgetSurvey.html?slug=${encodeURIComponent(slug)}`;
      });

      document.getElementById('mssOpenWidget')?.addEventListener('click', () => {
        const slug = getSlug();
        if (!slug) return alert('School slug not ready yet.');
        window.open(`/Widget.html?slug=${encodeURIComponent(slug)}`, '_blank', 'noopener');
      });
    })();
  </script>
</body>
</html>
