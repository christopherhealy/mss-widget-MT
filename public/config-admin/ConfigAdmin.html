<!-- Build: 2025-11-13 11:05 ET (ConfigAdmin ‚Äì Advanced per-slug config) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MSS Widget ‚Äì Advanced Config</title>
  <style>
    :root{ --edge:#e5e7eb; --muted:#6b7280; --blue:#1a5cff; --card:#fff; --bg:#f6f7fb; }
    html,body{
      margin:0;
      background:var(--bg);
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#111827;
    }

    .topRow{
      position:sticky;
      top:0;
      z-index:40;
      background:var(--bg);
      padding:8px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      border-bottom:1px solid var(--edge);
    }
    .title{font-weight:800}
    .admin-nav{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
    }
    .admin-nav a{
      color:#2563eb;
      text-decoration:none;
    }
    .admin-nav a:hover{text-decoration:underline;}
    .admin-nav span{margin:0 4px;}
    #slugTag{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--edge);
      background:#f9fafb;
      color:#4b5563;
    }

    .toolbar{
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--edge);
      background:#fff;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      font-size:13px;
    }
    .btn.primary{background:var(--blue); color:#fff; border-color:transparent;}
    .btn.small{padding:7px 10px;border-radius:10px;}
    .btn.ghost{background:#fff;}

    .wrap{
      max-width:1200px;
      margin:10px auto 18px auto;
      padding:0 12px;
      display:grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,0.9fr);
      gap:16px;
      align-items:start;
    }
    @media (max-width:1020px){
      .wrap{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--edge);
      border-radius:16px;
      box-shadow:0 10px 28px rgba(0,0,0,.05);
      overflow:hidden;
    }
    .sectionPad{padding:14px;}
    .muted{color:var(--muted); font-size:12px;}
    .label{font-size:12px; color:#374151;}
    input[type="text"],
    input[type="number"],
    input[type="url"],
    input[type="password"],
    select{
      width:100%;
      border:1px solid var(--edge);
      border-radius:12px;
      padding:9px 11px;
      font:inherit;
      background:#fff;
    }
    .row{display:grid; gap:6px; margin-bottom:12px;}

    details{border-top:1px solid var(--edge);}    
    summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      gap:8px;
      padding:12px 14px;
      font-weight:700;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none;}
    .chev{transition:transform .2s ease;}
    details[open] .chev{transform:rotate(90deg);}    
    .secInner{padding:0 14px 14px 14px;}

    /* Preview */
    .pvShell{padding:18px;}
    .preview{
      background:#fff;
      border:1px solid var(--edge);
      border-radius:16px;
      overflow:hidden;
    }
    .pvHead{
      padding:24px 18px 8px;
      display:grid;
      justify-items:center;
      background:linear-gradient(180deg,#fff,#f4f7ff);
    }
    .pvLogo{
      width:180px;
      height:120px;
      object-fit:contain;
      border-radius:12px;
      background:#fff;
      border:1px dashed #d1d5db;
    }
    .pvBrand{margin-top:10px; font-weight:800; text-align:center;}
    .pvBody{padding:18px; background:#fff;}
    .pvCounter{color:var(--muted); font-size:12px; margin-bottom:6px; text-align:center;}
    .pvQ{font-size:16px; line-height:1.5; text-align:center;}
    .pvNav{display:flex; gap:12px; justify-content:center; margin-top:12px;}
    .pill{
      padding:10px 18px;
      border-radius:999px;
      border:1px solid var(--edge);
      background:#fff;
      cursor:pointer;
    }
    .pvToolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      margin-top:14px;
    }
    .pvBtn{
      border-radius:999px;
      border:1px solid var(--edge);
      background:#fff;
      padding:10px 14px;
      font-weight:700;
      opacity:.55;
      cursor:not-allowed;
      font-size:13px;
    }
    .pvRecbar{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      margin-top:8px;
    }
    .pvDot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#ef4444;
      opacity:.35;
    }
    .pvMuted{color:var(--muted); font-size:12px; text-align:center;}
    .pvAudio{margin-top:8px; text-align:center;}
    .pvPowered{margin-top:12px; text-align:center; color:var(--muted); font-size:12px;}

    #toast{
      position:fixed;
      right:14px;
      bottom:14px;
      background:#111827;
      color:#fff;
      font-size:13px;
      padding:10px 12px;
      border-radius:12px;
      opacity:0;
      transform:translateY(10px);
      transition:all .2s;
      z-index:2200;
    }
    #toast.show{opacity:1; transform:translateY(0);}
  </style>
</head>
<body>

<!-- Top header -->
<div class="topRow">
  <div style="display:flex;flex-direction:column;gap:2px;">
    <div class="title">Widget Config ‚Äì Advanced</div>
    <div class="admin-nav">
      <a href="../WidgetAdmin.html">Widget setup</a>
      <span>¬∑</span>
      <a href="ConfigAdmin.html"><strong>Advanced config</strong></a>
      <span>¬∑</span>
      <a href="../questions-admin/WidgetSurvey.html">Question editor</a>
      <span>¬∑</span>
      <span id="slugTag"></span>
    </div>
  </div>
  <div class="toolbar">
    <button id="saveAll" type="button" class="btn primary">Save config‚Ä¶</button>
    <button id="openWidget" type="button" class="btn">Open Widget</button>
  </div>
</div>

<div class="wrap">
  <!-- LEFT: advanced controls -->
  <div class="card">
    
    <!-- Branding -->
    <details open>
      <summary><span class="chev">‚ñ∏</span> Branding</summary>
      <div class="secInner">
        <div class="sectionPad">
          <div class="row">
            <div class="label">Brand headline</div>
            <input id="brandHeadline" type="text" placeholder="e.g. CEFR Assessment">
          </div>
          <div class="row">
            <div class="label">‚ÄúPowered by‚Äù label</div>
            <input id="brandPoweredBy" type="text" placeholder="e.g. Powered by MSS Vox">
          </div>
          <div class="row">
            <div class="label">Brand image</div>
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
              <button type="button" class="btn ghost" id="brandImageBtn">Choose image‚Ä¶</button>
              <input id="brandImageFile" type="file" accept="image/*" style="display:none;">
              <span id="brandImageName" class="muted">No file chosen</span>
            </div>
            <div class="muted" style="margin-top:6px;">
              Used as the logo in the widget header. PNG/JPG, ideally square (‚â§ 512 px).
            </div>
          </div>
        </div>
      </div>
    </details>

    <!-- API & Authentication -->
    <details open>
      <summary><span class="chev">‚ñ∏</span> API &amp; Authentication</summary>
      <div class="secInner">
        <div class="sectionPad">
          <div class="row">
            <label class="label">
              <input id="apiEnabled" type="checkbox" style="margin-right:6px;">
              Enable MSS API integration
            </label>
            <div class="muted">
              Controls whether the widget calls the MSS scoring API. When off, the widget can still
              record audio but won‚Äôt send it for scoring.
            </div>
          </div>
          <div class="row">
            <div class="label">API Base URL</div>
            <input id="apiBase" type="url" placeholder="https://app.myspeakingscore.com">
          </div>
          <div class="row">
            <div class="label">API Key</div>
            <input id="apiKey" type="text" placeholder="Paste your MSS API key">
          </div>
          <div class="row">
            <div class="label">API Secret</div>
            <input id="apiSecret" type="password" placeholder="Paste your X-API-SECRET">
          </div>
          <div class="row">
            <div class="label">Admin write key (X-ADMIN-KEY)</div>
            <input id="adminWriteKey" type="password" placeholder="Used by Admin tools for PUT calls">
            <div class="muted">
              Stored in <code>CONFIG.admin.writeKey</code> and reused by WidgetAdmin / ConfigAdmin.
            </div>
          </div>
        </div>
      </div>
    </details>

    <!-- Logging & Uploads -->
    <details>
      <summary><span class="chev">‚ñ∏</span> Logging &amp; Uploads</summary>
      <div class="secInner">
        <div class="sectionPad">
          <div class="row">
            <label class="label">
              <input id="logEnabled" type="checkbox" style="margin-right:6px;">
              Enable submission logging
            </label>
            <div class="muted">
              When enabled, the widget will POST a JSON log of each submission to the logger URL.
            </div>
          </div>
          <div class="row">
            <div class="label">Logger URL</div>
            <input id="logUrl" type="url" placeholder="https://msswidget-dev.onrender.com/log/submission">
          </div>
          <div class="row">
            <label class="label">
              <input id="permitUpload" type="checkbox" style="margin-right:6px;">
              Permit file uploads instead of recording
            </label>
            <div class="muted">
              Controls the ‚ÄúChoose an audio file‚Äù button. Stored in <code>CONFIG.upload.allowed</code>.
            </div>
          </div>
        </div>
      </div>
    </details>

    <!-- Audio limits & Theme -->
    <details>
      <summary><span class="chev">‚ñ∏</span> Audio limits &amp; Theme</summary>
      <div class="secInner">
        <div class="sectionPad">
          <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <div class="label">Audio min seconds</div>
              <input id="minSeconds" type="number" min="1" step="1" placeholder="30">
            </div>
            <div>
              <div class="label">Audio max seconds</div>
              <input id="maxSeconds" type="number" min="1" step="1" placeholder="61">
            </div>
          </div>
          <div class="row">
            <div class="label">Widget theme</div>
            <select id="themeSelect">
              <option value="apple">Apple</option>
              <option value="default">Default</option>
            </select>
            <div class="muted">Same theme field used by <code>Widget.html</code> and <code>WidgetAdmin.html</code>.</div>
          </div>
        </div>
      </div>
    </details>

    <!-- Labels & text -->
    <details>
      <summary><span class="chev">‚ñ∏</span> Labels &amp; text</summary>
      <div class="secInner">
        <div class="sectionPad">
          <div class="muted" style="margin-bottom:8px;">
            Toggle which labels appear in the widget and customise the wording below.
          </div>
          <div id="labelsAdvanced"></div>
          <hr style="border:none;border-top:1px solid var(--edge);margin:12px 0;">
          <div id="labelsText"></div>
        </div>
      </div>
    </details>

    <div class="sectionPad" style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="saveAllBottom" type="button" class="btn">Save config‚Ä¶</button>
    </div>
  </div>

  <!-- RIGHT: live preview -->
  <div class="card pvShell">
    <h3 style="margin:0 0 8px 0; font-size:14px; padding:0 4px;">Preview</h3>
    <div class="muted" style="padding:0 4px 8px 4px;">
      Uses current <code>form</code>, <code>config</code> and <code>image</code> from the server (per slug, Postgres-backed with JSON fallback).
    </div>
    <div class="preview">
      <div class="pvHead">
        <img id="pvLogo" class="pvLogo" alt="Logo preview">
        <div id="pvBrand" class="pvBrand">Brand headline</div>
      </div>
      <div class="pvBody">
        <div id="pvCounter" class="pvCounter"></div>
        <div id="pvQ" class="pvQ"></div>
        <div class="pvNav">
          <button id="pvPrev" type="button" class="pill">Previous</button>
          <button id="pvNext" type="button" class="pill">Next</button>
        </div>
        <div class="pvToolbar">
          <button type="button" class="pvBtn" disabled id="pvRecordBtn">Record your response</button>
          <button type="button" class="pvBtn" disabled id="pvStopBtn">Stop</button>
          <button type="button" class="pvBtn" disabled id="pvUploadBtn">Choose an audio file</button>
          <button type="button" class="pvBtn" disabled id="pvSubmitBtn">Submit for scoring</button>
        </div>
        <div class="pvRecbar">
          <span class="pvDot"></span>
          <span id="pvRecState" class="pvMuted">Not recording</span>
        </div>
        <div class="pvAudio"><div id="pvLength" class="pvMuted"></div></div>
        <div id="pvPowered" class="pvPowered">Powered by MSS Vox</div>
      </div>
    </div>
  </div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<script>
/* ========= SLUG + service base ========= */
const params = new URLSearchParams(window.location.search);
const SLUG = (params.get('slug') || 'mss-demo').trim();

const SAVE_MODE = 'remote'; // 'remote' | 'local'

const SERVICE_BASE = window.location.hostname.includes('localhost')
  ? 'http://localhost:3000'
  : 'https://msswidget-dev.onrender.com';

const mode = SERVICE_BASE.includes('localhost') ? 'LOCAL DEV' : 'RENDER PROD';
console.log(`üß© ConfigAdmin running in ${mode} mode for slug="${SLUG}" via`, SERVICE_BASE);

/* ========= state ========= */
let FORM = null;     // same per-slug form object used by Widget & WidgetSurvey
let CONFIG = null;   // per-slug widget config
let IMAGE = null;    // per-slug logo / image object
let idx = 0;         // preview question index
let _fhConfig = null; // local fallback for config only

/* ========= helpers ========= */
const $  = (id) => document.getElementById(id);
const esc = (s) => String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&':'&gt;'}[c] || c));

function toast(msg, ok = true){
  const t = $('toast');
  t.textContent = msg;
  t.style.background = ok ? '#111827' : '#7c2d12';
  t.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => t.classList.remove('show'), 1800);
}

function getLogo(o){
  if (!o) return '';
  for (const k of ['logoDataUrl','dataUrl','logo','src','url','path']){
    if (o[k]) return String(o[k]);
  }
  return '';
}

function adminHeaders(){
  const h = { 'Content-Type': 'application/json' };
  if (CONFIG && CONFIG.admin && CONFIG.admin.writeKey){
    h['X-ADMIN-KEY'] = String(CONFIG.admin.writeKey);
  }
  return h;
}

/* ========= load all (Postgres per-slug with JSON fallback) ========= */
async function loadAll(){
  const ts = Date.now();

  const base = SERVICE_BASE.replace(/\/+$/,'');
  const formAdminUrl   = `${base}/api/admin/widget/${encodeURIComponent(SLUG)}`;
  const formConfigUrl  = `${base}/config/forms?slug=${encodeURIComponent(SLUG)}&ts=${ts}`;
  const configUrl      = `${base}/config/widget?slug=${encodeURIComponent(SLUG)}&ts=${ts}`;
  const imagesUrl      = `${base}/config/images?slug=${encodeURIComponent(SLUG)}&ts=${ts}`;

  // FORM (questions + labels)
  try{
    console.log('[ConfigAdmin] loading FORM from', formAdminUrl);
    const r = await fetch(formAdminUrl, {
      headers:{Accept:'application/json'},
      cache:'no-store'
    });
    if (!r.ok) throw new Error('admin widget form failed: '+r.status);
    const body = await r.json().catch(() => ({}));
    const fObj = body && typeof body === 'object' && (body.form || body) ? (body.form || body) : {};
    FORM = Object.assign({ headline:'Practice TOEFL Speaking Test', survey:[] }, fObj);
  }catch(err1){
    console.warn('[ConfigAdmin] admin widget form failed; trying /config/forms', err1);
    try{
      const r2 = await fetch(formConfigUrl, { cache:'no-store' });
      if (!r2.ok) throw new Error('config/forms failed: '+r2.status);
      FORM = await r2.json().catch(() => ({ headline:'Practice TOEFL Speaking Test', survey:[] }));
    }catch(err2){
      console.warn('[ConfigAdmin] /config/forms failed; falling back to local form.json', err2);
      try{
        const r3 = await fetch('form.json?ts='+ts, { cache:'no-store' });
        if (!r3.ok) throw new Error('form.json missing: '+r3.status);
        FORM = await r3.json().catch(() => ({ headline:'Practice TOEFL Speaking Test', survey:[] }));
      }catch(err3){
        console.error('[ConfigAdmin] all FORM loads failed; using empty default', err3);
        FORM = { headline:'Practice TOEFL Speaking Test', survey:[] };
      }
    }
  }

  // CONFIG (widget options)
  try{
    console.log('[ConfigAdmin] loading CONFIG from', configUrl);
    const r = await fetch(configUrl, { cache:'no-store' });
    if (!r.ok) throw new Error('config/widget failed: '+r.status);
    CONFIG = await r.json().catch(() => null);
  }catch(err){
    console.warn('[ConfigAdmin] CONFIG load failed; falling back to local config.json', err);
    try{
      const r2 = await fetch('config.json?ts='+ts, { cache:'no-store' });
      if (!r2.ok) throw new Error('local config.json missing: '+r2.status);
      CONFIG = await r2.json().catch(() => null);
    }catch(err2){
      console.error('[ConfigAdmin] all CONFIG loads failed; using default skeleton', err2);
      CONFIG = {
        editable:{
          headline:true,
          recordButton:true,
          previousButton:true,
          nextButton:true,
          poweredByLabel:true,
          uploadButton:true,
          stopButton:true,
          NotRecordingLabel:true,
          SubmitForScoringButton:true
        },
        theme:'apple',
        api:{ enabled:true, baseUrl:'', key:'', secret:'' },
        logger:{ enabled:false, url:'' },
        upload:{ allowed:true },
        audioMinSeconds:30,
        audioMaxSeconds:61,
        admin:{ writeKey:'' }
      };
    }
  }

  // IMAGE (logo)
  try{
    console.log('[ConfigAdmin] loading IMAGE from', imagesUrl);
    const r = await fetch(imagesUrl, { cache:'no-store' });
    if (!r.ok) throw new Error('config/images failed: '+r.status);
    IMAGE = await r.json().catch(() => null) || { logoDataUrl:'' };
  }catch(err){
    console.warn('[ConfigAdmin] IMAGE load failed; falling back to local image.json', err);
    try{
      const r2 = await fetch('image.json?ts='+ts, { cache:'no-store' });
      if (!r2.ok) throw new Error('local image.json missing: '+r2.status);
      IMAGE = await r2.json().catch(() => ({ logoDataUrl:'' }));
    }catch(err2){
      console.error('[ConfigAdmin] all IMAGE loads failed; using empty image', err2);
      IMAGE = { logoDataUrl:'' };
    }
  }

  // Wire controls & render
  $('slugTag').textContent = `slug=${SLUG}`;
  bindAdvancedControls();
  renderPreview();
}

/* ========= wire advanced form controls ========= */
function bindAdvancedControls(){
  FORM = FORM || { headline:'', survey:[] };
  CONFIG = CONFIG || {};
  IMAGE = IMAGE || { logoDataUrl:'' };

  // --- branding text ---
  $('brandHeadline').value = FORM.headline || '';
  $('brandHeadline').addEventListener('input', e => {
    FORM.headline = e.target.value;
    renderPreview();
  });

  $('brandPoweredBy').value = FORM.poweredByLabel || '';
  $('brandPoweredBy').addEventListener('input', e => {
    FORM.poweredByLabel = e.target.value;
    renderPreview();
  });

  // --- branding image ---
  const brandBtn   = $('brandImageBtn');
  const brandFile  = $('brandImageFile');
  const brandName  = $('brandImageName');

  if (brandBtn && brandFile && brandName){
    const currentLogo = getLogo(IMAGE);
    if (currentLogo){
      brandName.textContent = 'Current logo loaded';
    }

    brandBtn.addEventListener('click', () => brandFile.click());

    brandFile.addEventListener('change', () => {
      const file = brandFile.files && brandFile.files[0];
      if (!file){
        brandName.textContent = 'No file chosen';
        return;
      }
      brandName.textContent = file.name;
      const reader = new FileReader();
      reader.onload = () => {
        IMAGE = IMAGE || {};
        IMAGE.logoDataUrl = reader.result;
        renderPreview();
      };
      reader.readAsDataURL(file);
    });
  }

  // --- API ---
  CONFIG.api = CONFIG.api || {};
  $('apiEnabled').checked = !!CONFIG.api.enabled;
  $('apiEnabled').addEventListener('change', e => {
    CONFIG.api.enabled = e.target.checked;
  });

  $('apiBase').value = CONFIG.api.baseUrl || '';
  $('apiBase').addEventListener('input', e => {
    CONFIG.api.baseUrl = e.target.value.trim();
  });

  $('apiKey').value = CONFIG.api.key || '';
  $('apiKey').addEventListener('input', e => {
    CONFIG.api.key = e.target.value;
  });

  $('apiSecret').value = CONFIG.api.secret || '';
  $('apiSecret').addEventListener('input', e => {
    CONFIG.api.secret = e.target.value;
  });

  CONFIG.admin = CONFIG.admin || {};
  $('adminWriteKey').value = CONFIG.admin.writeKey || '';
  $('adminWriteKey').addEventListener
